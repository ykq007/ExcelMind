<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExcelMind - ExcelÊô∫ËÉΩÊï∞ÊçÆÈóÆÁ≠îÂä©Êâã</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-hover: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #333333;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
            --sidebar-width: 300px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Left Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
        }

        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header h1::before {
            content: "üìä";
            font-size: 1.3rem;
        }

        .sidebar-header .subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Upload Section */
        .upload-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 20px 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-zone.drag-over {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
        }

        .upload-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        #file-input {
            display: none;
        }

        /* Tables Section */
        .tables-section {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .tables-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .tables-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tables-count {
            background: var(--accent);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .btn-clear-all {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.7rem;
            transition: color 0.2s;
        }

        .btn-clear-all:hover {
            color: var(--error);
        }

        .tables-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }

        .table-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
        }

        .table-item:hover {
            background: var(--bg-hover);
            border-color: var(--border);
        }

        .table-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent);
        }

        .table-item.selected {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .table-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--warning);
            cursor: pointer;
            flex-shrink: 0;
        }

        .table-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .table-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .table-info {
            flex: 1;
            min-width: 0;
        }

        .table-name {
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .table-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
            opacity: 0;
        }

        .table-item:hover .table-delete {
            opacity: 1;
        }

        .table-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .tables-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Join Button */
        .join-btn-container {
            padding: 8px 0;
            margin-top: auto;
        }

        .btn-join {
            width: 100%;
            padding: 10px 16px;
            background: var(--gradient-2);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-join:hover {
            transform: scale(1.02);
        }

        .btn-join:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 450px;
            max-width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.3rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-select option {
            background: var(--bg-tertiary);
        }

        .form-warning {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--warning);
            margin-bottom: 16px;
        }

        .table-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 8px 0;
        }

        .btn-add-key {
            background: transparent;
            border: 1px dashed var(--accent);
            color: var(--accent);
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
        }

        .btn-add-key:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .key-pair-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: nowrap;
        }

        .key-select-group {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .key-select-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .key-pair-row select {
            width: 100%;
            min-width: 0;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .key-pair-row select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .key-pair-arrow {
            font-size: 1rem;
            color: var(--text-muted);
            flex-shrink: 0;
            padding-top: 18px;
        }

        .btn-remove-key {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            flex-shrink: 0;
            padding-top: 18px;
        }

        .btn-remove-key:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .btn-confirm {
            padding: 10px 24px;
            background: var(--gradient-2);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm:hover {
            transform: scale(1.02);
        }

        .btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-width: 0;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .active-table-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--accent);
            border-radius: 16px;
            font-size: 0.95rem;
            color: var(--accent);
            max-width: 400px;
        }

        .active-table-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .active-table-indicator span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .active-table-indicator:empty {
            display: none;
        }

        /* Upload Overlay */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .upload-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .upload-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .upload-overlay-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-overlay-sub {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-badge.loaded {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-badge.loaded .status-dot {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .chat-empty h3 {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .message {
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-content {
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--gradient-1);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .table-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-muted);
            margin-bottom: 6px;
            border: 1px solid var(--border);
        }

        .table-badge.current {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Markdown */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 0.9rem;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .message-content th {
            background: var(--bg-hover);
            font-weight: 600;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border);
        }

        .message-content code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .message-content p {
            margin-bottom: 8px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Thinking & Tool Blocks */
        .thinking-block,
        .tool-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .thinking-block {
            border-left: 3px solid var(--accent);
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .thinking-content {
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .thinking-block.finished {
            border-left-color: var(--border);
            opacity: 0.8;
        }

        .thinking-block.finished .thinking-header {
            color: var(--text-secondary);
        }

        .tool-block {
            border-left: 3px solid var(--warning);
        }

        .tool-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .tool-name {
            background: rgba(245, 158, 11, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .tool-args,
        .tool-result {
            background: var(--bg-primary);
            padding: 10px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            overflow-x: auto;
            margin-top: 8px;
        }

        .tool-result {
            max-height: 200px;
            overflow-y: auto;
        }

        .tool-result.has-chart {
            max-height: none;
            overflow: visible;
        }

        .tool-result.success {
            border-left: 2px solid var(--success);
        }

        .tool-result.error {
            border-left: 2px solid var(--error);
        }

        /* Â∑•ÂÖ∑ÊèèËø∞Ê†∑Âºè */
        .tool-description {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .tool-description b {
            color: var(--accent);
        }

        .tool-details {
            margin-top: 8px;
        }

        .tool-details summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 4px 0;
        }

        .tool-details summary:hover {
            color: var(--text-secondary);
        }

        /* ÁªìÊûúÊòæÁ§∫Ê†∑Âºè */
        .result-value {
            color: var(--success);
            font-weight: 600;
        }

        .result-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .result-data-preview {
            margin-top: 8px;
        }

        .result-data-preview summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .result-data-preview pre {
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 150px;
            font-size: 0.75rem;
        }

        .tool-result code {
            background: rgba(99, 102, 241, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        /* Chart Container Styles */
        .chart-result-container {
            margin-top: 12px;
        }

        .chart-header {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .chart-container {
            width: 100%;
            height: 400px;
            min-height: 400px;
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            padding: 16px;
            box-sizing: border-box;
        }

        /* Input Section */
        .chat-input-container {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 52px;
            max-height: 150px;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn {
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Right Sidebar: Knowledge Base */
        .right-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
            padding: 16px;
        }

        .knowledge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .knowledge-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .knowledge-count {
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .knowledge-actions {
            display: flex;
            gap: 4px;
        }

        .kb-btn-small {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .kb-btn-small:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            flex: 1;
            margin-top: 8px;
        }

        .knowledge-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 10px;
        }

        .knowledge-item:hover {
            background: var(--bg-hover);
            border-color: var(--border);
        }

        .knowledge-item.selected {
            background: rgba(34, 197, 94, 0.15);
            border-color: var(--success);
        }

        .knowledge-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .knowledge-info {
            flex: 1;
            min-width: 0;
        }

        .knowledge-name {
            font-weight: 500;
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .knowledge-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .knowledge-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .knowledge-tag {
            font-size: 0.6rem;
            padding: 1px 6px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent);
            border-radius: 4px;
        }

        .knowledge-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
            opacity: 0;
        }

        .knowledge-item:hover .knowledge-delete {
            opacity: 1;
        }

        .knowledge-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .knowledge-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .knowledge-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-tertiary);
            margin-top: 8px;
        }

        .knowledge-upload-zone:hover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .knowledge-upload-zone.drag-over {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
        }

        .knowledge-upload-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .knowledge-upload-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Knowledge Modal */
        .kb-modal {
            width: 550px;
        }

        .kb-modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .kb-content-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }

        .kb-content-input {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            font-family: inherit;
        }

        .kb-content-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .kb-tags-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .kb-tags-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .kb-info-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .kb-info-item {
            flex: 1;
        }

        /* Password Modal */
        .password-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .password-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .password-modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .password-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .password-modal-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .password-input-group {
            margin-bottom: 20px;
        }

        .password-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .password-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .password-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .password-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .password-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .password-btn-cancel:hover {
            background: var(--border);
        }

        .password-btn-confirm {
            background: var(--gradient-1);
            color: white;
        }

        .password-btn-confirm:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <!-- Left Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>ExcelMind</h1>
            <div class="subtitle">Excel Êô∫ËÉΩÊï∞ÊçÆÈóÆÁ≠îÂä©Êâã</div>
        </div>

        <div class="upload-section">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">üìÅ</div>
                <p class="upload-text">ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º† Excel</p>
                <p class="upload-hint">ÊîØÊåÅÂ§ö‰∏™Êñá‰ª∂</p>
            </div>
            <input type="file" id="file-input" accept=".xlsx,.xls,.xlsm" multiple>
        </div>

        <div class="tables-section">
            <div class="tables-header">
                <div class="tables-title">
                    Êï∞ÊçÆË°®
                    <span class="tables-count" id="tables-count">0</span>
                </div>
                <button class="btn-clear-all" id="btn-clear-all">Ê∏ÖÁ©∫</button>
            </div>
            <div class="tables-list" id="tables-list">
                <div class="tables-empty" id="tables-empty">ÊöÇÊó†Êï∞ÊçÆË°®</div>
            </div>
            <div class="join-btn-container">
                <button class="btn-join" id="btn-join" disabled>
                    ü§ñ Êô∫ËÉΩËÅîË°®
                </button>
            </div>
        </div>
    </aside>

    <!-- Join Modal -->
    <div class="modal-overlay" id="join-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>üîó Ë°®Ê†ºËÅîÊü•</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Êñ∞Ë°®ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="join-name" placeholder="‰æãÂ¶ÇÔºöÁî®Êà∑ËÆ¢ÂçïËÅîÂêàË°®">
                </div>

                <div class="table-preview" id="table1-preview"></div>
                <div class="table-preview" id="table2-preview"></div>

                <div class="form-group">
                    <label class="form-label">ËøûÊé•Â≠óÊÆµ <button type="button" class="btn-add-key" id="btn-add-key">+
                            Ê∑ªÂä†Â≠óÊÆµ</button></label>
                    <div id="key-pairs-container">
                        <!-- Key pairs will be added here dynamically -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ËøûÊé•Á±ªÂûã</label>
                    <select class="form-select" id="join-type">
                        <option value="inner">inner - ‰ªÖ‰øùÁïôÂåπÈÖçË°å</option>
                        <option value="left">left - ‰øùÁïôÂ∑¶Ë°®ÂÖ®ÈÉ®</option>
                        <option value="right">right - ‰øùÁïôÂè≥Ë°®ÂÖ®ÈÉ®</option>
                        <option value="outer">outer - ‰øùÁïôÂÖ®ÈÉ®Ë°å</option>
                    </select>
                </div>

                <div class="form-warning">
                    <span>‚ö†Ô∏è</span>
                    <span>ËØ∑Á°Æ‰øùÂØπÂ∫îÁöÑËøûÊé•Â≠óÊÆµÊï∞ÊçÆÁ±ªÂûãÂíåÂê´‰πâ‰∏ÄËá¥ÔºåÂê¶ÂàôÂèØËÉΩ‰∫ßÁîüÈîôËØØÁªìÊûú„ÄÇ</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="join-cancel">ÂèñÊ∂à</button>
                <button class="btn-confirm" id="join-confirm">Á°ÆËÆ§ËøûÊé•</button>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div class="modal-overlay" id="kb-modal">
        <div class="modal kb-modal">
            <div class="modal-header">
                <h2 id="kb-modal-title">üìö Áü•ËØÜËØ¶ÊÉÖ</h2>
                <button class="modal-close" id="kb-modal-close">&times;</button>
            </div>
            <div class="modal-body kb-modal-body">
                <div class="form-group">
                    <label class="form-label">Ê†áÈ¢ò</label>
                    <input type="text" class="form-input" id="kb-title" placeholder="Áü•ËØÜÊù°ÁõÆÊ†áÈ¢ò">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÜÖÂÆπ</label>
                    <textarea class="kb-content-input" id="kb-content" placeholder="ËæìÂÖ•Áü•ËØÜÂÜÖÂÆπ..."></textarea>
                </div>
                <div class="kb-info-row">
                    <div class="kb-info-item">
                        <label class="form-label">ÂàÜÁ±ª</label>
                        <select class="form-select" id="kb-category">
                            <option value="general">ÈÄöÁî®</option>
                            <option value="field_rule">Â≠óÊÆµËßÑÂàô</option>
                            <option value="task_pattern">‰ªªÂä°Ê®°Âºè</option>
                            <option value="business_logic">‰∏öÂä°ÈÄªËæë</option>
                        </select>
                    </div>
                    <div class="kb-info-item">
                        <label class="form-label">‰ºòÂÖàÁ∫ß</label>
                        <select class="form-select" id="kb-priority">
                            <option value="normal">ÊôÆÈÄö</option>
                            <option value="high">È´ò</option>
                            <option value="low">‰Ωé</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê†áÁ≠æÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                    <input type="text" class="kb-tags-input" id="kb-tags" placeholder="‰æãÂ¶ÇÔºöË¥¶Êúü, Êó•ÊúüÊ†ºÂºè, YYYYMM">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="kb-modal-cancel">ÂèñÊ∂à</button>
                <button class="btn-confirm" id="kb-modal-save">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Upload Overlay -->
    <div class="upload-overlay" id="upload-overlay">
        <div class="upload-spinner"></div>
        <div class="upload-overlay-text" id="upload-overlay-text">Ê≠£Âú®‰∏ä‰º†...</div>
        <div class="upload-overlay-sub" id="upload-overlay-sub">ËØ∑Á®çÂÄôÔºåÊñá‰ª∂ËæÉÂ§ßÊó∂ÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥</div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header">
            <span class="header-title">
                <span class="active-table-label">ÂΩìÂâçÁõÆÊ†áË°®Ôºö</span>
                <div class="active-table-indicator" id="active-table-indicator">ËØ∑ÂÖà‰∏ä‰º†Êï∞ÊçÆË°®</div>
            </span>
        </header>

        <section class="chat-section">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-empty" id="chat-empty">
                    <div class="chat-empty-icon">üí¨</div>
                    <h3>ÂºÄÂßãÂØπËØù</h3>
                    <p>Âú®Â∑¶‰æß‰∏ä‰º† Excel Êñá‰ª∂ÂêéÔºåÂç≥ÂèØËØ¢ÈóÆÊï∞ÊçÆÈóÆÈ¢ò</p>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chat-input" placeholder="ËØ∑ÂÖà‰∏ä‰º† Excel Êñá‰ª∂" rows="1"
                        disabled></textarea>
                    <button class="send-btn" id="send-btn" disabled>
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" transform="rotate(-45 12 12)" />
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Right Sidebar: Knowledge Base -->
    <aside class="right-sidebar">
        <div class="knowledge-header">
            <div class="knowledge-title">
                üìö Áü•ËØÜÂ∫ì
                <span class="knowledge-count" id="knowledge-count">0</span>
            </div>
            <div class="knowledge-actions">
                <button class="kb-btn-small" id="kb-btn-add" title="Ê∑ªÂä†Áü•ËØÜ">+</button>
                <button class="kb-btn-small" id="kb-btn-refresh" title="Âà∑Êñ∞">‚Üª</button>
            </div>
        </div>
        <div class="knowledge-list" id="knowledge-list">
            <div class="knowledge-empty" id="knowledge-empty">ÊöÇÊó†Áü•ËØÜÊù°ÁõÆ</div>
        </div>
        <div class="knowledge-upload-zone" id="kb-upload-zone">
            <div class="knowledge-upload-icon">üìÑ</div>
            <p class="knowledge-upload-text">ÊãñÊãΩÊàñÁÇπÂáª‰∏ä‰º† (.md/.txt)</p>
        </div>
        <input type="file" id="kb-file-input" accept=".md,.txt,.markdown" style="display:none">
    </aside>

    <!-- Password Modal -->
    <div class="password-modal-overlay" id="password-modal">
        <div class="password-modal">
            <div class="password-modal-title">üîê Êñá‰ª∂Â∑≤Âä†ÂØÜ</div>
            <div class="password-modal-desc" id="password-filename">ËØ∑ËæìÂÖ•Êñá‰ª∂ÂØÜÁ†Å‰ª•Ëß£ÂØÜ</div>
            <div class="password-input-group">
                <label for="password-input">ÂØÜÁ†Å</label>
                <input type="password" id="password-input" class="password-input" placeholder="ËæìÂÖ•ÂØÜÁ†ÅÔºàÁïôÁ©∫Ë°®Á§∫Êó†ÂØÜÁ†ÅÔºâ">
            </div>
            <div class="password-modal-actions">
                <button class="password-btn password-btn-cancel" id="password-cancel">ÂèñÊ∂à</button>
                <button class="password-btn password-btn-confirm" id="password-confirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script>
        marked.setOptions({ breaks: true, gfm: true });

        // Elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const tablesList = document.getElementById('tables-list');
        const tablesCount = document.getElementById('tables-count');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const btnClearAll = document.getElementById('btn-clear-all');
        const btnJoin = document.getElementById('btn-join');
        const joinModal = document.getElementById('join-modal');
        const modalClose = document.getElementById('modal-close');
        const joinCancel = document.getElementById('join-cancel');
        const joinConfirm = document.getElementById('join-confirm');
        const joinName = document.getElementById('join-name');
        const keyPairsContainer = document.getElementById('key-pairs-container');
        const btnAddKey = document.getElementById('btn-add-key');
        const joinType = document.getElementById('join-type');
        const table1Preview = document.getElementById('table1-preview');
        const table2Preview = document.getElementById('table2-preview');
        const uploadOverlay = document.getElementById('upload-overlay');
        const uploadOverlayText = document.getElementById('upload-overlay-text');
        const uploadOverlaySub = document.getElementById('upload-overlay-sub');
        const activeTableIndicator = document.getElementById('active-table-indicator');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordFilename = document.getElementById('password-filename');
        const passwordCancel = document.getElementById('password-cancel');
        const passwordConfirm = document.getElementById('password-confirm');

        let isProcessing = false;
        let conversationHistory = [];
        let tables = [];
        let activeTableId = null;
        let tableNames = {};
        let selectedTableIds = [];
        let table1Columns = [];
        let table2Columns = [];
        let pendingFile = null; // Á≠âÂæÖÂØÜÁ†ÅËæìÂÖ•ÁöÑÊñá‰ª∂
        let passwordResolve = null; // Promise resolver

        // Password modal handlers
        passwordCancel.addEventListener('click', () => {
            passwordModal.classList.remove('show');
            passwordInput.value = '';
            if (passwordResolve) {
                passwordResolve(null);
                passwordResolve = null;
            }
            pendingFile = null;
        });

        passwordConfirm.addEventListener('click', () => {
            const password = passwordInput.value;
            passwordModal.classList.remove('show');
            passwordInput.value = '';
            if (passwordResolve) {
                passwordResolve(password);
                passwordResolve = null;
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordConfirm.click();
            }
        });

        // ÊòæÁ§∫ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
        function showPasswordModal(filename) {
            return new Promise((resolve) => {
                passwordFilename.textContent = `Êñá‰ª∂ "${filename}" Â∑≤Âä†ÂØÜÔºåËØ∑ËæìÂÖ•ÂØÜÁ†Å`;
                passwordInput.value = '';
                passwordModal.classList.add('show');
                passwordInput.focus();
                passwordResolve = resolve;
            });
        }

        // Upload handlers
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); });
        btnClearAll.addEventListener('click', async () => { if (confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâË°®Ôºü')) await resetAgent(); });

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return ['.xlsx', '.xls', '.xlsm'].includes(ext);
            });

            if (validFiles.length === 0) return;

            // ÊòæÁ§∫‰∏ä‰º†ÈÅÆÁΩ©
            uploadOverlay.classList.add('show');

            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                uploadOverlayText.textContent = `Ê≠£Âú®‰∏ä‰º† (${i + 1}/${validFiles.length}): ${file.name}`;
                uploadOverlaySub.textContent = 'ËØ∑Á®çÂÄôÔºåÊñá‰ª∂ËæÉÂ§ßÊó∂ÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥';
                await uploadFile(file);
            }

            // ÈöêËóè‰∏ä‰º†ÈÅÆÁΩ©
            uploadOverlay.classList.remove('show');
        }

        async function uploadFile(file, password = null) {
            const formData = new FormData();
            formData.append('file', file);
            if (password) {
                formData.append('password', password);
            }
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || '‰∏ä‰º†Â§±Ë¥•';

                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂä†ÂØÜÈîôËØØ
                    if (errorMsg.includes('Âä†ÂØÜ') || errorMsg.includes('ÂØÜÁ†Å')) {
                        // ÊòæÁ§∫ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
                        const enteredPassword = await showPasswordModal(file.name);
                        if (enteredPassword !== null) {
                            // Áî®Êà∑ËæìÂÖ•‰∫ÜÂØÜÁ†ÅÔºåÈáçËØï‰∏ä‰º†
                            return await uploadFile(file, enteredPassword);
                        } else {
                            // Áî®Êà∑ÂèñÊ∂à
                            return;
                        }
                    }

                    throw new Error(errorMsg);
                }
                const data = await response.json();
                if (data.tables) updateTablesList(data.tables);
                if (data.table_id) {
                    activeTableId = data.table_id;
                    tableNames[data.table_id] = file.name;
                }
            } catch (error) {
                alert('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
            }
            updateStatus();
        }

        function updateTablesList(tablesData) {
            tables = tablesData;
            tablesCount.textContent = tables.length;
            selectedTableIds = selectedTableIds.filter(id => tables.some(t => t.id === id));
            updateJoinButton();

            if (tables.length === 0) {
                tablesList.innerHTML = '<div class="tables-empty">ÊöÇÊó†Êï∞ÊçÆË°®</div>';
                return;
            }

            tablesList.innerHTML = '';
            tables.forEach(table => {
                tableNames[table.id] = table.filename;
                const isSelected = selectedTableIds.includes(table.id);
                const icon = table.is_joined ? 'üîó' : 'üìä';
                const tooltip = table.is_joined && table.source_tables
                    ? `ËøûÊé•Ë°®Ôºö${table.source_tables.join(' + ')}`
                    : table.filename;

                const item = document.createElement('div');
                item.className = `table-item${table.is_active ? ' active' : ''}${isSelected ? ' selected' : ''}`;
                item.dataset.id = table.id;
                item.innerHTML = `
                    <input type="checkbox" class="table-checkbox" ${isSelected ? 'checked' : ''} ${table.is_joined ? 'disabled' : ''}>
                    <div class="table-item-left">
                        <span class="table-icon">${icon}</span>
                        <div class="table-info">
                            <div class="table-name" title="${tooltip}">${table.filename}</div>
                            <div class="table-meta">${table.total_rows}Ë°å √ó ${table.total_columns}Âàó</div>
                        </div>
                    </div>
                    <button class="table-delete" title="Âà†Èô§">√ó</button>
                `;

                const checkbox = item.querySelector('.table-checkbox');
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTableSelection(table.id, checkbox.checked);
                });

                item.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('table-delete') || e.target.classList.contains('table-checkbox')) return;
                    await setActiveTable(table.id);
                });

                item.querySelector('.table-delete').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await deleteTable(table.id);
                });

                tablesList.appendChild(item);
                if (table.is_active) activeTableId = table.id;
            });

            enableChat();
        }

        function toggleTableSelection(tableId, isChecked) {
            if (isChecked) {
                if (selectedTableIds.length < 2) {
                    selectedTableIds.push(tableId);
                } else {
                    // Âè™ÂÖÅËÆ∏ÈÄâ2‰∏™ÔºåÂèñÊ∂àÊúÄÊó©ÈÄâÁöÑ
                    selectedTableIds.shift();
                    selectedTableIds.push(tableId);
                    // Êõ¥Êñ∞UI
                    updateTablesList(tables);
                }
            } else {
                selectedTableIds = selectedTableIds.filter(id => id !== tableId);
            }
            updateJoinButton();
            updateTableItemStyles();
        }

        function updateTableItemStyles() {
            document.querySelectorAll('.table-item').forEach(item => {
                const id = item.dataset.id;
                const checkbox = item.querySelector('.table-checkbox');
                if (selectedTableIds.includes(id)) {
                    item.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    item.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            });
        }

        function updateJoinButton() {
            btnJoin.disabled = selectedTableIds.length !== 2;
            if (selectedTableIds.length === 2) {
                const t1 = tables.find(t => t.id === selectedTableIds[0]);
                const t2 = tables.find(t => t.id === selectedTableIds[1]);
                btnJoin.innerHTML = `ü§ñ Êô∫ËÉΩËÅîË°®: ${t1?.filename?.substring(0, 6) || 'Ë°®1'}... + ${t2?.filename?.substring(0, 6) || 'Ë°®2'}...`;
            } else {
                btnJoin.innerHTML = selectedTableIds.length === 0
                    ? 'ü§ñ Êô∫ËÉΩËÅîË°® (ÈÄâÊã©2Âº†Ë°®)'
                    : `ü§ñ Êô∫ËÉΩËÅîË°® (Â∑≤ÈÄâ${selectedTableIds.length}/2)`;
            }
        }

        // Join Modal
        btnJoin.addEventListener('click', openJoinModal);
        modalClose.addEventListener('click', closeJoinModal);
        joinCancel.addEventListener('click', closeJoinModal);
        joinModal.addEventListener('click', (e) => { if (e.target === joinModal) closeJoinModal(); });
        btnAddKey.addEventListener('click', () => addKeyPair());

        function addKeyPair(key1Value = '', key2Value = '') {
            const row = document.createElement('div');
            row.className = 'key-pair-row';
            row.innerHTML = `
                <div class="key-select-group">
                    <span class="key-select-label">Ë°®1Â≠óÊÆµ</span>
                    <select class="key1-select">
                        ${table1Columns.map(c => `<option value="${c}" ${c === key1Value ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <span class="key-pair-arrow">‚Üî</span>
                <div class="key-select-group">
                    <span class="key-select-label">Ë°®2Â≠óÊÆµ</span>
                    <select class="key2-select">
                        ${table2Columns.map(c => `<option value="${c}" ${c === key2Value ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <button type="button" class="btn-remove-key" title="ÁßªÈô§">√ó</button>
            `;

            row.querySelector('.btn-remove-key').addEventListener('click', () => {
                if (keyPairsContainer.children.length > 1) {
                    row.remove();
                } else {
                    alert('Ëá≥Â∞ëÈúÄË¶Å‰∏Ä‰∏™ËøûÊé•Â≠óÊÆµ');
                }
            });

            keyPairsContainer.appendChild(row);
        }

        async function openJoinModal() {
            if (selectedTableIds.length !== 2) return;

            const [id1, id2] = selectedTableIds;
            const t1 = tables.find(t => t.id === id1);
            const t2 = tables.find(t => t.id === id2);

            // ÊòæÁ§∫AIÂàÜÊûêÈÅÆÁΩ©
            uploadOverlayText.textContent = 'ü§ñ AI Ê≠£Âú®ÂàÜÊûêË°®ÁªìÊûÑ...';
            uploadOverlaySub.textContent = 'ËØ∑Á®çÂÄôÔºåAIÊ≠£Âú®Êô∫ËÉΩÂåπÈÖçËÅîË°®Â≠óÊÆµ';
            uploadOverlay.classList.add('show');

            table1Preview.textContent = `Ë°®1: ${t1?.filename} (${t1?.total_rows}Ë°å)`;
            table2Preview.textContent = `Ë°®2: ${t2?.filename} (${t2?.total_rows}Ë°å)`;

            // Ëé∑ÂèñÂàóÂêç
            try {
                const [cols1, cols2] = await Promise.all([
                    fetch(`/tables/${id1}/columns`).then(r => r.json()),
                    fetch(`/tables/${id2}/columns`).then(r => r.json())
                ]);

                table1Columns = cols1.columns || [];
                table2Columns = cols2.columns || [];
            } catch (e) {
                uploadOverlay.classList.remove('show');
                alert('Ëé∑ÂèñÂàó‰ø°ÊÅØÂ§±Ë¥•');
                return;
            }

            // Ë∞ÉÁî®AIÂª∫ËÆÆAPI
            let aiSuggestion = null;
            try {
                const response = await fetch('/tables/suggest-join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table1_id: id1, table2_id: id2 })
                });

                if (response.ok) {
                    const data = await response.json();
                    aiSuggestion = data.suggestion;
                }
            } catch (e) {
                console.warn('AIÂª∫ËÆÆËé∑ÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº', e);
            }

            uploadOverlay.classList.remove('show');

            // Ê∏ÖÁ©∫Âπ∂Ê∑ªÂä†Â≠óÊÆµÂØπ
            keyPairsContainer.innerHTML = '';

            if (aiSuggestion && aiSuggestion.keys1 && aiSuggestion.keys2) {
                // ‰ΩøÁî®AIÂª∫ËÆÆÈ¢ÑÂ°´ÂÖÖ
                joinName.value = aiSuggestion.new_name || `${t1?.filename?.split('.')[0]}_${t2?.filename?.split('.')[0]}_ËÅîÂêà`;
                joinType.value = aiSuggestion.join_type || 'inner';

                // Ê∑ªÂä†AIÂª∫ËÆÆÁöÑÂ≠óÊÆµÂØπ
                for (let i = 0; i < aiSuggestion.keys1.length; i++) {
                    addKeyPair(aiSuggestion.keys1[i], aiSuggestion.keys2[i]);
                }

                // ÊòæÁ§∫AIÂª∫ËÆÆÂéüÂõ†
                if (aiSuggestion.reason) {
                    console.log('AIÂª∫ËÆÆÂéüÂõ†:', aiSuggestion.reason);
                }
            } else {
                // ÈªòËÆ§ÂÄº
                joinName.value = `${t1?.filename?.split('.')[0] || 'Ë°®1'}_${t2?.filename?.split('.')[0] || 'Ë°®2'}_ËÅîÂêà`;
                addKeyPair();
            }

            joinModal.classList.add('show');
        }

        function closeJoinModal() {
            joinModal.classList.remove('show');
        }

        joinConfirm.addEventListener('click', async () => {
            const name = joinName.value.trim();
            if (!name) { alert('ËØ∑ËæìÂÖ•Êñ∞Ë°®ÂêçÁß∞'); return; }

            // Êî∂ÈõÜÊâÄÊúâÂ≠óÊÆµÂØπ
            const keyRows = keyPairsContainer.querySelectorAll('.key-pair-row');
            const keys1 = [];
            const keys2 = [];

            keyRows.forEach(row => {
                keys1.push(row.querySelector('.key1-select').value);
                keys2.push(row.querySelector('.key2-select').value);
            });

            if (keys1.length === 0) {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰∏Ä‰∏™ËøûÊé•Â≠óÊÆµ');
                return;
            }

            joinConfirm.disabled = true;
            joinConfirm.textContent = 'ËøûÊé•‰∏≠...';

            try {
                const response = await fetch('/tables/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        table1_id: selectedTableIds[0],
                        table2_id: selectedTableIds[1],
                        keys1: keys1,
                        keys2: keys2,
                        join_type: joinType.value,
                        new_name: name
                    })
                });

                if (!response.ok) throw new Error((await response.json()).detail || 'ËøûÊé•Â§±Ë¥•');

                const data = await response.json();
                selectedTableIds = [];
                if (data.tables) updateTablesList(data.tables);
                closeJoinModal();
                updateStatus();
            } catch (error) {
                alert('ËøûÊé•Â§±Ë¥•: ' + error.message);
            } finally {
                joinConfirm.disabled = false;
                joinConfirm.textContent = 'Á°ÆËÆ§ËøûÊé•';
            }
        });

        async function setActiveTable(tableId) {
            try {
                const response = await fetch('/tables/active', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId })
                });
                if (!response.ok) throw new Error((await response.json()).detail);
                const data = await response.json();
                activeTableId = tableId;
                if (data.tables) updateTablesList(data.tables);
                updateStatus();
            } catch (error) {
                alert('ÂàáÊç¢Â§±Ë¥•: ' + error.message);
            }
        }

        async function deleteTable(tableId) {
            try {
                const response = await fetch(`/tables/${tableId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error((await response.json()).detail);
                const data = await response.json();
                activeTableId = data.active_table_id;
                selectedTableIds = selectedTableIds.filter(id => id !== tableId);
                if (data.tables) updateTablesList(data.tables);
                updateStatus();
                if (tables.length === 0) disableChat();
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        function updateStatus() {
            if (tables.length === 0) {
                activeTableIndicator.innerHTML = 'ËØ∑ÂÖà‰∏ä‰º†Êï∞ÊçÆË°®';
            } else {
                const activeTable = tables.find(t => t.is_active);
                // Êõ¥Êñ∞Ê¥ªË∑ÉË°®ÊåáÁ§∫Âô®
                if (activeTable) {
                    const icon = activeTable.is_joined ? 'üîó' : 'üìä';
                    activeTableIndicator.innerHTML = `${icon} <span title="${activeTable.filename}">${activeTable.filename}</span>`;
                } else {
                    activeTableIndicator.innerHTML = 'ËØ∑ÈÄâÊã©‰∏ÄÂº†Ë°®';
                }
            }
        }

        function enableChat() {
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.placeholder = 'ËæìÂÖ•ÈóÆÈ¢òÔºå‰æãÂ¶ÇÔºöËøô‰∏™Ë°®ÊúâÂ§öÂ∞ëË°åÔºü';
            chatInput.focus();
        }

        function disableChat() {
            chatInput.disabled = true;
            sendBtn.disabled = true;
            chatInput.placeholder = 'ËØ∑ÂÖà‰∏ä‰º† Excel Êñá‰ª∂';
        }

        async function resetAgent() {
            try {
                await fetch('/reset', { method: 'POST' });
                tables = [];
                activeTableId = null;
                tableNames = {};
                conversationHistory = [];
                selectedTableIds = [];
                tablesList.innerHTML = '<div class="tables-empty">ÊöÇÊó†Êï∞ÊçÆË°®</div>';
                tablesCount.textContent = '0';
                statusBadge.classList.remove('loaded');
                statusText.textContent = 'Êú™Âä†ËΩΩÊñá‰ª∂';
                disableChat();
                updateJoinButton();
                chatMessages.innerHTML = `
                    <div class="chat-empty" id="chat-empty">
                        <div class="chat-empty-icon">üí¨</div>
                        <h3>ÂºÄÂßãÂØπËØù</h3>
                        <p>Âú®Â∑¶‰æß‰∏ä‰º† Excel Êñá‰ª∂ÂêéÔºåÂç≥ÂèØËØ¢ÈóÆÊï∞ÊçÆÈóÆÈ¢ò</p>
                    </div>
                `;
            } catch (error) { console.error('Reset failed:', error); }
        }

        // Chat handlers
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
        });
        sendBtn.addEventListener('click', sendMessage);

        const toolBlockMap = new Map();

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing || tables.length === 0) return;

            isProcessing = true;
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendBtn.disabled = true;
            toolBlockMap.clear();

            const emptyState = document.getElementById('chat-empty');
            if (emptyState) emptyState.remove();

            const currentTableId = activeTableId;
            const currentTableName = tableNames[currentTableId] || 'Êú™Áü•Ë°®';

            addMessage('user', message, currentTableId, currentTableName);
            conversationHistory.push({ role: 'user', content: message, tableId: currentTableId });

            const assistantMsg = addMessage('assistant', '', currentTableId, currentTableName);
            const contentDiv = assistantMsg.querySelector('.message-content');

            let currentThinkingBlock = null;
            let currentToolBlock = null;
            let responseContainer = document.createElement('div');
            contentDiv.appendChild(responseContainer);

            let responseTableId = currentTableId;

            try {
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        history: conversationHistory.slice(0, -1).map(h => ({
                            role: h.role,
                            content: h.content,
                            tableName: tableNames[h.tableId] || ''
                        }))
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let responseText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.slice(6));
                                if (event.type === 'table_info') { responseTableId = event.table_id; continue; }
                                handleStreamEvent(event, contentDiv, {
                                    getThinkingBlock: () => {
                                        if (!currentThinkingBlock) {
                                            currentThinkingBlock = createThinkingBlock();
                                            contentDiv.insertBefore(currentThinkingBlock, responseContainer);
                                        }
                                        return currentThinkingBlock;
                                    },
                                    finishThinkingBlock: () => {
                                        if (currentThinkingBlock) {
                                            currentThinkingBlock.classList.add('finished');

                                            // ÈöêËóèÂä†ËΩΩÂä®Áîª
                                            const dots = currentThinkingBlock.querySelector('.loading-dots');
                                            if (dots) dots.remove(); // Áõ¥Êé•ÁßªÈô§Êõ¥ÂΩªÂ∫ï

                                            // Êõ¥Êñ∞Ê†áÈ¢òÊñáÊú¨
                                            const headerText = currentThinkingBlock.querySelector('.thinking-header span:nth-child(2)');
                                            if (headerText) headerText.textContent = 'ÊÄùËÄÉËøáÁ®ã';

                                            currentThinkingBlock = null;
                                        }
                                    },
                                    createToolBlock: (name, args) => {
                                        const block = createToolBlock(name, args);
                                        contentDiv.insertBefore(block, responseContainer);
                                        return block;
                                    },
                                    getCurrentToolBlock: () => currentToolBlock,
                                    setCurrentToolBlock: (block) => { currentToolBlock = block; },
                                    appendResponse: (text) => { responseText += text; responseContainer.innerHTML = formatMarkdown(responseText); },
                                    setResponse: (text) => { responseText = text; responseContainer.innerHTML = formatMarkdown(responseText); }
                                });
                            } catch (e) { console.error('Parse error:', e); }
                        }
                    }
                }

                if (responseText) {
                    conversationHistory.push({ role: 'assistant', content: responseText, tableId: responseTableId });
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                responseContainer.innerHTML = `<span style="color: var(--error)">ÈîôËØØ: ${error.message}</span>`;
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function handleStreamEvent(event, contentDiv, ctx) {
            switch (event.type) {
                case 'thinking':
                    const tb = ctx.getThinkingBlock();
                    tb.querySelector('.thinking-content').textContent = event.content;
                    tb.style.display = 'block';
                    break;
                case 'thinking_done': ctx.finishThinkingBlock(); break;
                case 'tool_call':
                    ctx.finishThinkingBlock();
                    const toolBlock = ctx.createToolBlock(event.name, event.args);
                    toolBlockMap.set(event.name, toolBlock);
                    ctx.setCurrentToolBlock(toolBlock);
                    break;
                case 'tool_result':
                    let targetBlock = toolBlockMap.get(event.name) || ctx.getCurrentToolBlock();
                    if (targetBlock) addToolResult(targetBlock, event.result);
                    break;
                case 'token': ctx.finishThinkingBlock(); ctx.appendResponse(event.content); break;
                case 'done': if (event.content) ctx.setResponse(event.content); break;
                case 'error': ctx.setResponse(`<span style="color: var(--error)">${event.content}</span>`); break;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(role, content, tableId, tableName) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.dataset.tableId = tableId || '';

            let tableBadge = '';
            if (tableId && tableName && role === 'assistant') {
                const isCurrentTable = tableId === activeTableId;
                tableBadge = `<div class="table-badge${isCurrentTable ? ' current' : ''}">üìä ${tableName}</div>`;
            }

            msgDiv.innerHTML = `<div class="message-content">${tableBadge}${formatMarkdown(content)}</div>`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msgDiv;
        }

        function createThinkingBlock() {
            const div = document.createElement('div');
            div.className = 'thinking-block';
            div.innerHTML = `
                <div class="thinking-header">
                    <span>üß†</span><span>ÊÄùËÄÉ‰∏≠</span>
                    <div class="loading-dots"><span></span><span></span><span></span></div>
                </div>
                <div class="thinking-content"></div>
            `;
            return div;
        }

        function createToolBlock(name, args) {
            const div = document.createElement('div');
            div.className = 'tool-block';

            // ÁîüÊàêËá™ÁÑ∂ËØ≠Ë®ÄÊèèËø∞
            const description = getToolDescription(name, args);

            div.innerHTML = `
                <div class="tool-header"><span>üîß</span><span>ÊâßË°åÊìç‰Ωú:</span><span class="tool-name">${getToolDisplayName(name)}</span></div>
                <div class="tool-description">${description}</div>
                <details class="tool-details">
                    <summary>Êü•ÁúãËØ¶ÁªÜÂèÇÊï∞</summary>
                    <div class="tool-args">${JSON.stringify(args, null, 2)}</div>
                </details>
            `;
            return div;
        }

        // Ëé∑ÂèñÂ∑•ÂÖ∑ÁöÑ‰∏≠ÊñáÊòæÁ§∫ÂêçÁß∞
        function getToolDisplayName(name) {
            const names = {
                'filter_data': 'Êï∞ÊçÆÁ≠õÈÄâ',
                'aggregate_data': 'Êï∞ÊçÆËÅöÂêà',
                'group_and_aggregate': 'ÂàÜÁªÑÁªüËÆ°',
                'sort_data': 'Êï∞ÊçÆÊéíÂ∫è',
                'search_data': 'Êï∞ÊçÆÊêúÁ¥¢',
                'get_column_stats': 'ÂàóÁªüËÆ°',
                'get_unique_values': 'Ëé∑ÂèñÂîØ‰∏ÄÂÄº',
                'get_data_preview': 'Êï∞ÊçÆÈ¢ÑËßà',
                'get_current_time': 'Ëé∑ÂèñÊó∂Èó¥',
                'calculate': 'Êï∞Â≠¶ËÆ°ÁÆó',
                'generate_chart': 'üìä ÁîüÊàêÂõæË°®'
            };
            return names[name] || name;
        }

        // Â∞ÜÂ∑•ÂÖ∑Ë∞ÉÁî®ÂèÇÊï∞ËΩ¨Êç¢‰∏∫Ëá™ÁÑ∂ËØ≠Ë®ÄÊèèËø∞
        function getToolDescription(name, args) {
            switch (name) {
                case 'filter_data': {
                    const parts = [];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    } else if (args.column && args.operator) {
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${formatCondition(args.column, args.operator, args.value)}`);
                    }
                    if (args.select_columns && args.select_columns.length > 0) {
                        parts.push(`ËøîÂõûÂàó: ${args.select_columns.join(', ')}`);
                    }
                    if (args.limit) parts.push(`ÊúÄÂ§öËøîÂõû ${args.limit} Êù°`);
                    return parts.join('<br>') || 'Á≠õÈÄâÊï∞ÊçÆ';
                }
                case 'aggregate_data': {
                    const parts = [];
                    const funcName = { sum: 'Ê±ÇÂíå', mean: 'Âπ≥ÂùáÂÄº', count: 'ËÆ°Êï∞', min: 'ÊúÄÂ∞èÂÄº', max: 'ÊúÄÂ§ßÂÄº', median: '‰∏≠‰ΩçÊï∞', std: 'Ê†áÂáÜÂ∑Æ' };
                    parts.push(`ÂØπ <b>${args.column}</b> ÂàóËÆ°ÁÆó <b>${funcName[args.agg_func] || args.agg_func}</b>`);
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'group_and_aggregate': {
                    const funcName = { sum: 'Ê±ÇÂíå', mean: 'Âπ≥ÂùáÂÄº', count: 'ËÆ°Êï∞', min: 'ÊúÄÂ∞èÂÄº', max: 'ÊúÄÂ§ßÂÄº' };
                    const parts = [`Êåâ <b>${args.group_by}</b> ÂàÜÁªÑÔºåÂØπ <b>${args.agg_column}</b> ËÆ°ÁÆó <b>${funcName[args.agg_func] || args.agg_func}</b>`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'sort_data': {
                    const order = args.ascending === false ? 'ÈôçÂ∫è' : 'ÂçáÂ∫è';
                    const parts = [`Êåâ <b>${args.column}</b> ${order}ÊéíÂ∫è`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'search_data':
                    return `ÊêúÁ¥¢ÂÖ≥ÈîÆËØç: <b>${args.keyword}</b>` + (args.columns ? ` (Âú® ${args.columns.join(', ')} Âàó‰∏≠)` : ' (ÂÖ®Ë°®)');
                case 'get_column_stats': {
                    const parts = [`Ëé∑Âèñ <b>${args.column}</b> ÂàóÁöÑÁªüËÆ°‰ø°ÊÅØ`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'get_unique_values': {
                    const parts = [`Ëé∑Âèñ <b>${args.column}</b> ÂàóÁöÑÂîØ‰∏ÄÂÄº`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Á≠õÈÄâÊù°‰ª∂: ${conditions.join(' ‰∏î ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'get_data_preview':
                    return `È¢ÑËßàÂâç ${args.n_rows || 10} Ë°åÊï∞ÊçÆ`;
                case 'get_current_time':
                    return 'Ëé∑ÂèñÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥';
                case 'calculate':
                    if (args.expressions && args.expressions.length > 0) {
                        return `ËÆ°ÁÆóË°®ËææÂºè: ${args.expressions.map(e => `<code>${e}</code>`).join(', ')}`;
                    }
                    return 'ÊâßË°åÊï∞Â≠¶ËÆ°ÁÆó';
                case 'generate_chart': {
                    const chartTypes = { bar: 'Êü±Áä∂Âõæ', line: 'ÊäòÁ∫øÂõæ', pie: 'È•ºÂõæ', scatter: 'Êï£ÁÇπÂõæ', radar: 'Èõ∑ËææÂõæ', funnel: 'ÊºèÊñóÂõæ', auto: 'Ëá™Âä®Êé®Ëçê' };
                    const parts = [`ÁîüÊàê <b>${chartTypes[args.chart_type] || args.chart_type || 'Ëá™Âä®Êé®Ëçê'}</b>`];
                    if (args.title) parts.push(`Ê†áÈ¢ò: ${args.title}`);
                    if (args.x_column) parts.push(`XËΩ¥: ${args.x_column}`);
                    if (args.y_column) parts.push(`YËΩ¥: ${args.y_column}`);
                    if (args.group_by) parts.push(`ÂàÜÁªÑ: ${args.group_by}`);
                    return parts.join(', ');
                }
                default:
                    return JSON.stringify(args);
            }
        }

        // Ê†ºÂºèÂåñÁ≠õÈÄâÊù°‰ª∂‰∏∫Ëá™ÁÑ∂ËØ≠Ë®Ä
        function formatCondition(column, operator, value) {
            const opNames = {
                '==': 'Á≠â‰∫é',
                '!=': '‰∏çÁ≠â‰∫é',
                '>': 'Â§ß‰∫é',
                '<': 'Â∞è‰∫é',
                '>=': 'Â§ß‰∫éÁ≠â‰∫é',
                '<=': 'Â∞è‰∫éÁ≠â‰∫é',
                'contains': 'ÂåÖÂê´',
                'startswith': 'ÂºÄÂ§¥ÊòØ',
                'endswith': 'ÁªìÂ∞æÊòØ'
            };
            return `<b>${column}</b> ${opNames[operator] || operator} <b>${value}</b>`;
        }

        function addToolResult(toolBlock, result) {
            const resultDiv = document.createElement('div');
            const isError = result && result.error;
            const hasChart = result && result.chart;
            resultDiv.className = `tool-result ${isError ? 'error' : 'success'}${hasChart ? ' has-chart' : ''}`;

            if (isError) {
                resultDiv.innerHTML = `<strong>‚ùå ÈîôËØØ:</strong> ${result.error}`;
            } else {
                // ÁîüÊàêÂèãÂ•ΩÁöÑÁªìÊûúÊèèËø∞
                resultDiv.innerHTML = formatToolResult(result);
            }
            toolBlock.appendChild(resultDiv);
        }

        // Â∞ÜÂ∑•ÂÖ∑ÁªìÊûúËΩ¨Êç¢‰∏∫ÂèãÂ•ΩÊ†ºÂºè
        function formatToolResult(result) {
            if (!result || typeof result !== 'object') {
                return `<strong>‚úì ÁªìÊûú:</strong> ${result}`;
            }

            // Â§ÑÁêÜÂõæË°®ÁªìÊûú
            if (result.chart) {
                const chartId = 'echart-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const chartHtml = `
                    <div class="chart-result-container">
                        <div class="chart-header"><strong>üìä ${result.message || 'ÂõæË°®Â∑≤ÁîüÊàê'}</strong></div>
                        <div class="chart-container" id="${chartId}"></div>
                    </div>
                `;
                // Âª∂ËøüÊ∏≤ÊüìÂõæË°®ÔºåÁ°Æ‰øù DOM Â∑≤ÊèíÂÖ•
                setTimeout(() => {
                    const container = document.getElementById(chartId);
                    if (container && typeof echarts !== 'undefined') {
                        const chart = echarts.init(container, 'dark');
                        chart.setOption(result.chart);
                        // ÂìçÂ∫îÂºèË∞ÉÊï¥
                        const resizeObserver = new ResizeObserver(() => chart.resize());
                        resizeObserver.observe(container);
                    }
                }, 100);
                return chartHtml;
            }

            const parts = ['<strong>‚úì ÊâßË°åÊàêÂäü</strong>'];

            // Â§ÑÁêÜËÅöÂêàÁªìÊûú
            if (result.result !== undefined && result.column && result.function) {
                const funcNames = { sum: 'ÊÄªÂíå', mean: 'Âπ≥ÂùáÂÄº', count: 'Êï∞Èáè', min: 'ÊúÄÂ∞èÂÄº', max: 'ÊúÄÂ§ßÂÄº', median: '‰∏≠‰ΩçÊï∞', std: 'Ê†áÂáÜÂ∑Æ' };
                parts.push(`<b>${result.column}</b> ÁöÑ${funcNames[result.function] || result.function}: <span class="result-value">${formatNumber(result.result)}</span>`);
                if (result.filtered_rows) {
                    parts.push(`<span class="result-meta">(Âü∫‰∫é ${result.filtered_rows} Êù°Êï∞ÊçÆ)</span>`);
                }
                return parts.join(' ');
            }

            // Â§ÑÁêÜÊó∂Èó¥ÁªìÊûú
            if (result.current_time) {
                return `<strong>‚úì ÂΩìÂâçÊó∂Èó¥:</strong> <span class="result-value">${result.current_time}</span> (${result.weekday || ''})`;
            }

            // Â§ÑÁêÜËÆ°ÁÆóÁªìÊûú
            if (result.results && typeof result.results === 'object') {
                const calcParts = ['<strong>‚úì ËÆ°ÁÆóÁªìÊûú:</strong><br>'];
                for (const [expr, val] of Object.entries(result.results)) {
                    calcParts.push(`<code>${expr}</code> = <span class="result-value">${formatNumber(val)}</span><br>`);
                }
                return calcParts.join('');
            }

            // Â§ÑÁêÜÊï∞ÊçÆÂàóË°®ÁªìÊûú
            if (result.data && Array.isArray(result.data)) {
                const summary = [`<strong>‚úì Êü•ËØ¢Âà∞ ${result.total_rows || result.data.length} Êù°Êï∞ÊçÆ</strong>`];
                if (result.returned_rows && result.returned_rows < result.total_rows) {
                    summary.push(`<span class="result-meta">(ÊòæÁ§∫Ââç ${result.returned_rows} Êù°)</span>`);
                }
                if (result.columns) {
                    summary.push(`<br><span class="result-meta">ÂåÖÂê´Âàó: ${result.columns.join(', ')}</span>`);
                }
                // ÊòæÁ§∫ÂâçÂá†Êù°Êï∞ÊçÆÁöÑÁÆÄË¶ÅÈ¢ÑËßà
                if (result.data.length > 0) {
                    const preview = result.data.slice(0, 3);
                    summary.push('<details class="result-data-preview"><summary>Êü•ÁúãÊï∞ÊçÆÈ¢ÑËßà</summary><pre>' + JSON.stringify(preview, null, 2) + '</pre></details>');
                }
                return summary.join(' ');
            }

            // Â§ÑÁêÜÁªüËÆ°‰ø°ÊÅØ
            if (result.column && (result.count !== undefined || result.unique_count !== undefined)) {
                const statParts = [`<strong>‚úì ${result.column} ÂàóÁªüËÆ°:</strong><br>`];
                if (result.count !== undefined) statParts.push(`ÊÄªÊï∞: <b>${result.count}</b> `);
                if (result.unique_count !== undefined) statParts.push(`ÂîØ‰∏ÄÂÄº: <b>${result.unique_count}</b> `);
                if (result.null_count !== undefined) statParts.push(`Á©∫ÂÄº: <b>${result.null_count}</b><br>`);
                if (result.min !== undefined) statParts.push(`ÊúÄÂ∞è: <b>${formatNumber(result.min)}</b> `);
                if (result.max !== undefined) statParts.push(`ÊúÄÂ§ß: <b>${formatNumber(result.max)}</b> `);
                if (result.mean !== undefined) statParts.push(`Âπ≥Âùá: <b>${formatNumber(result.mean)}</b>`);
                return statParts.join('');
            }

            // Â§ÑÁêÜÂîØ‰∏ÄÂÄºÁªìÊûú
            if (result.values && Array.isArray(result.values)) {
                const valueParts = [`<strong>‚úì ${result.column} ÂàóÊúâ ${result.total_unique} ‰∏™ÂîØ‰∏ÄÂÄº</strong>`];
                if (result.values.length > 0) {
                    const topValues = result.values.slice(0, 5).map(v => `${v.value} (${v.count})`).join(', ');
                    valueParts.push(`<br><span class="result-meta">ÂâçÂá†‰∏™: ${topValues}${result.values.length > 5 ? '...' : ''}</span>`);
                }
                return valueParts.join('');
            }

            // ÈªòËÆ§ÔºöÁ¥ßÂáëÊòæÁ§∫ JSON
            return `<strong>‚úì ÁªìÊûú:</strong><details><summary>Êü•ÁúãËØ¶ÊÉÖ</summary><pre>${JSON.stringify(result, null, 2)}</pre></details>`;
        }

        // Ê†ºÂºèÂåñÊï∞Â≠ó
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            if (typeof num !== 'number') return num;
            if (Number.isInteger(num)) return num.toLocaleString();
            return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function formatMarkdown(text) {
            if (!text) return '';
            try { return marked.parse(text); }
            catch (e) { return text; }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                if (data.excel_loaded && data.tables) {
                    updateTablesList(data.tables);
                    updateStatus();
                }
            } catch (error) { console.error('Status check failed:', error); }
        }

        checkStatus();

        // ============ Knowledge Base Management ============

        const kbList = document.getElementById('knowledge-list');
        const kbCount = document.getElementById('knowledge-count');
        const kbEmpty = document.getElementById('knowledge-empty');
        const kbUploadZone = document.getElementById('kb-upload-zone');
        const kbFileInput = document.getElementById('kb-file-input');
        const kbBtnAdd = document.getElementById('kb-btn-add');
        const kbBtnRefresh = document.getElementById('kb-btn-refresh');
        const kbModal = document.getElementById('kb-modal');
        const kbModalTitle = document.getElementById('kb-modal-title');
        const kbModalClose = document.getElementById('kb-modal-close');
        const kbModalCancel = document.getElementById('kb-modal-cancel');
        const kbModalSave = document.getElementById('kb-modal-save');
        const kbTitleInput = document.getElementById('kb-title');
        const kbContentInput = document.getElementById('kb-content');
        const kbCategorySelect = document.getElementById('kb-category');
        const kbPrioritySelect = document.getElementById('kb-priority');
        const kbTagsInput = document.getElementById('kb-tags');

        let knowledgeEntries = [];
        let currentKbEditId = null;

        // Upload handlers for knowledge files
        kbUploadZone.addEventListener('click', () => kbFileInput.click());
        kbUploadZone.addEventListener('dragover', (e) => { e.preventDefault(); kbUploadZone.classList.add('drag-over'); });
        kbUploadZone.addEventListener('dragleave', () => kbUploadZone.classList.remove('drag-over'));
        kbUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            kbUploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleKbFiles(e.dataTransfer.files);
        });
        kbFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleKbFiles(e.target.files); });

        // Button handlers
        kbBtnAdd.addEventListener('click', () => openKbModal());
        kbBtnRefresh.addEventListener('click', () => loadKnowledgeEntries());
        kbModalClose.addEventListener('click', () => closeKbModal());
        kbModalCancel.addEventListener('click', () => closeKbModal());
        kbModalSave.addEventListener('click', () => saveKnowledgeEntry());

        async function handleKbFiles(files) {
            const validFiles = Array.from(files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return ['.md', '.txt', '.markdown'].includes(ext);
            });

            if (validFiles.length === 0) {
                alert('‰ªÖÊîØÊåÅ .md, .txt, .markdown Êñá‰ª∂');
                return;
            }

            for (const file of validFiles) {
                await uploadKbFile(file);
            }
            loadKnowledgeEntries();
        }

        async function uploadKbFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/knowledge/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).detail || '‰∏ä‰º†Â§±Ë¥•');
                const data = await response.json();
                if (data.success) {
                    console.log('Áü•ËØÜÊñá‰ª∂‰∏ä‰º†ÊàêÂäü:', data.title);
                }
            } catch (error) {
                alert('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
            }
        }

        async function loadKnowledgeEntries() {
            try {
                const response = await fetch('/knowledge');
                const data = await response.json();
                if (data.entries) {
                    knowledgeEntries = data.entries;
                    renderKnowledgeList();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁü•ËØÜÂ∫ìÂ§±Ë¥•:', error);
            }
        }

        function renderKnowledgeList() {
            kbCount.textContent = knowledgeEntries.length;

            if (knowledgeEntries.length === 0) {
                kbList.innerHTML = '<div class="knowledge-empty">ÊöÇÊó†Áü•ËØÜÊù°ÁõÆ</div>';
                return;
            }

            kbList.innerHTML = knowledgeEntries.map(entry => {
                const categoryLabel = {
                    'general': 'ÈÄöÁî®',
                    'field_rule': 'Â≠óÊÆµ',
                    'task_pattern': '‰ªªÂä°',
                    'business_logic': '‰∏öÂä°'
                }[entry.category] || entry.category;

                const tagsHtml = (entry.tags || [])
                    .filter(t => t && t.trim())
                    .slice(0, 3)
                    .map(t => `<span class="knowledge-tag">${t}</span>`)
                    .join('');

                return `
                    <div class="knowledge-item" data-id="${entry.id}" onclick="viewKnowledgeEntry('${entry.id}')">
                        <span class="knowledge-icon">üìÑ</span>
                        <div class="knowledge-info">
                            <div class="knowledge-name">${entry.title || 'Êú™ÂëΩÂêç'}</div>
                            <div class="knowledge-meta">${categoryLabel}</div>
                            ${tagsHtml ? `<div class="knowledge-tags">${tagsHtml}</div>` : ''}
                        </div>
                        <button class="knowledge-delete" onclick="event.stopPropagation(); deleteKnowledgeEntry('${entry.id}')" title="Âà†Èô§">√ó</button>
                    </div>
                `;
            }).join('');
        }

        async function viewKnowledgeEntry(id) {
            try {
                const response = await fetch(`/knowledge/${id}`);
                if (!response.ok) throw new Error('Ëé∑ÂèñÂ§±Ë¥•');
                const entry = await response.json();

                currentKbEditId = id;
                kbModalTitle.textContent = 'üìù ÁºñËæëÁü•ËØÜ';
                kbTitleInput.value = entry.title || '';
                kbContentInput.value = entry.content || '';
                kbCategorySelect.value = entry.category || 'general';
                kbPrioritySelect.value = entry.priority || 'normal';
                kbTagsInput.value = (entry.tags || []).join(', ');

                kbModal.classList.add('show');
            } catch (error) {
                alert('Ëé∑ÂèñÁü•ËØÜËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message);
            }
        }

        function openKbModal() {
            currentKbEditId = null;
            kbModalTitle.textContent = 'üìö Ê∑ªÂä†Áü•ËØÜ';
            kbTitleInput.value = '';
            kbContentInput.value = '';
            kbCategorySelect.value = 'general';
            kbPrioritySelect.value = 'normal';
            kbTagsInput.value = '';
            kbModal.classList.add('show');
        }

        function closeKbModal() {
            kbModal.classList.remove('show');
            currentKbEditId = null;
        }

        async function saveKnowledgeEntry() {
            const content = kbContentInput.value.trim();
            if (!content) {
                alert('ËØ∑ËæìÂÖ•Áü•ËØÜÂÜÖÂÆπ');
                return;
            }

            const tags = kbTagsInput.value.split(',').map(t => t.trim()).filter(t => t);
            const data = {
                content: content,
                title: kbTitleInput.value.trim() || null,
                category: kbCategorySelect.value,
                priority: kbPrioritySelect.value,
                tags: tags
            };

            try {
                let response;
                if (currentKbEditId) {
                    // Update existing
                    response = await fetch(`/knowledge/${currentKbEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new
                    response = await fetch('/knowledge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) throw new Error((await response.json()).detail || '‰øùÂ≠òÂ§±Ë¥•');

                closeKbModal();
                loadKnowledgeEntries();
            } catch (error) {
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        async function deleteKnowledgeEntry(id) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Áü•ËØÜÊù°ÁõÆÔºü')) return;

            try {
                const response = await fetch(`/knowledge/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error((await response.json()).detail || 'Âà†Èô§Â§±Ë¥•');
                loadKnowledgeEntries();
            } catch (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // Make functions globally accessible
        window.viewKnowledgeEntry = viewKnowledgeEntry;
        window.deleteKnowledgeEntry = deleteKnowledgeEntry;

        // Load knowledge entries on page load
        loadKnowledgeEntries();
    </script>
</body>

</html>