<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExcelMind - Intelligent Excel Data Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* ========== Palette Tokens (Zinc Scale) ========== */
            --zinc-950: #09090b;
            --zinc-900: #18181b;
            --zinc-800: #27272a;
            --zinc-700: #3f3f46;
            --zinc-600: #52525b;
            --zinc-500: #71717a;
            --zinc-400: #a1a1aa;
            --zinc-300: #d4d4d8;
            --zinc-200: #e4e4e7;
            --zinc-100: #f4f4f5;
            --zinc-50: #fafafa;

            --indigo-600: #4f46e5;
            --indigo-500: #6366f1;
            --indigo-400: #818cf8;

            --emerald-600: #059669;
            --emerald-500: #10b981;

            /* ========== Semantic Tokens ========== */
            /* Backgrounds */
            --bg-primary: var(--zinc-950);
            --bg-secondary: var(--zinc-900);
            --bg-tertiary: var(--zinc-800);
            --bg-hover: var(--zinc-700);
            --bg-subtle: #1f1f22;

            /* Text (WCAG AA compliant) */
            --text-primary: var(--zinc-50);
            --text-secondary: var(--zinc-400);  /* 4.54:1 on zinc-950 */
            --text-muted: var(--zinc-500);      /* 4.61:1 on zinc-950 */

            /* Accent */
            --accent: var(--indigo-500);
            --accent-hover: var(--indigo-600);
            --accent-subtle: rgba(99, 102, 241, 0.1);
            --accent-text: #ffffff;  /* 8.59:1 on indigo-500 */

            /* Status Colors */
            --success: var(--emerald-500);
            --success-hover: var(--emerald-600);
            --warning: #f59e0b;
            --error: #ef4444;

            /* Borders */
            --border: var(--zinc-800);
            --border-hover: var(--zinc-700);
            --border-subtle: rgba(255, 255, 255, 0.05);

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
            --shadow-focus: 0 0 0 3px rgba(99, 102, 241, 0.15);

            /* Gradients */
            --gradient-accent: linear-gradient(135deg, var(--indigo-500) 0%, var(--indigo-600) 100%);
            --gradient-success: linear-gradient(135deg, var(--emerald-500) 0%, var(--emerald-600) 100%);

            /* Layout */
            --sidebar-width: 280px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Transitions */
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
            --duration-fast: 150ms;
            --duration: 200ms;
            --duration-slow: 300ms;

            /* Typography */
            --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: none;
        }

        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Left Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
        }

        .sidebar-header {
            padding: 24px 20px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header h1 {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .sidebar-header h1::before {
            content: "üìä";
            font-size: 1.25rem;
            opacity: 0.9;
        }

        .sidebar-header .subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 6px;
            margin-left: 36px;
            font-weight: 400;
        }

        /* Upload Section */
        .upload-section {
            padding: 20px;
        }

        .upload-zone {
            border: 1.5px dashed var(--border-hover);
            border-radius: var(--radius);
            padding: 28px 16px;
            text-align: center;
            transition: all var(--duration) var(--ease);
            cursor: pointer;
            background: transparent;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }

        .upload-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-subtle);
            border-style: solid;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .upload-zone:hover .upload-icon {
            opacity: 1;
        }

        .upload-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        #file-input {
            display: none;
        }

        /* Tables Section */
        .tables-section {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px 16px;
            display: flex;
            flex-direction: column;
        }

        .tables-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 12px 8px 8px;
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .tables-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tables-count {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.625rem;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: var(--radius-sm);
            min-width: 20px;
            text-align: center;
        }

        .btn-clear-all {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: background-color var(--duration) var(--ease),
                        color var(--duration) var(--ease);
        }

        .btn-clear-all:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .tables-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .table-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color var(--duration) var(--ease),
                        border-color var(--duration) var(--ease),
                        transform var(--duration-fast) var(--ease);
            gap: 10px;
        }

        .table-item:hover {
            background: var(--bg-subtle);
        }

        .table-item.active {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }

        .table-item.selected {
            background: rgba(245, 158, 11, 0.06);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .table-checkbox {
            width: 15px;
            height: 15px;
            accent-color: var(--warning);
            cursor: pointer;
            flex-shrink: 0;
        }

        .table-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .table-icon {
            font-size: 1rem;
            flex-shrink: 0;
            opacity: 0.7;
            transition: opacity var(--duration) var(--ease);
        }

        .table-item:hover .table-icon,
        .table-item.active .table-icon {
            opacity: 1;
        }

        .table-info {
            flex: 1;
            min-width: 0;
        }

        .table-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--duration) var(--ease);
        }

        .table-item.active .table-name {
            color: var(--text-primary);
        }

        .table-meta {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .table-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.125rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            border-radius: var(--radius-sm);
            transition: background-color var(--duration) var(--ease),
                        color var(--duration) var(--ease),
                        opacity var(--duration) var(--ease);
            flex-shrink: 0;
            opacity: 0;
        }

        .table-item:hover .table-delete {
            opacity: 1;
        }

        .table-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .tables-empty {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
            font-size: 0.8125rem;
            border: 1.5px dashed var(--border);
            border-radius: var(--radius);
            margin-top: 8px;
        }

        /* Join Button */
        .join-btn-container {
            padding: 16px 20px;
            margin-top: auto;
            border-top: 1px solid var(--border-subtle);
        }

        .btn-join {
            width: 100%;
            height: 40px;
            padding: 0 16px;
            background: var(--accent);
            border: none;
            border-radius: var(--radius);
            color: var(--accent-text);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color var(--duration) var(--ease),
                        transform var(--duration-fast) var(--ease),
                        box-shadow var(--duration) var(--ease);
        }

        .btn-join:hover:not(:disabled) {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }

        .btn-join:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-join:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--duration-slow) var(--ease),
                        visibility var(--duration-slow) var(--ease);
        }

        @supports (backdrop-filter: blur(1px)) {
            .modal-overlay {
                backdrop-filter: blur(4px);
                background: rgba(0, 0, 0, 0.5);
            }
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 480px;
            max-width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transform: scale(0.95) translateY(10px);
            transition: transform var(--duration-slow) var(--ease);
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.0625rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: background-color var(--duration) var(--ease),
                        color var(--duration) var(--ease);
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            transition: border-color var(--duration) var(--ease),
                        box-shadow var(--duration) var(--ease);
        }

        .form-input:hover,
        .form-select:hover {
            border-color: var(--border-hover);
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--accent);
            box-shadow: var(--shadow-focus);
        }

        .form-select option {
            background: var(--bg-tertiary);
        }

        .form-warning {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--warning);
            margin-bottom: 16px;
        }

        .table-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 8px 0;
        }

        .btn-add-key {
            background: transparent;
            border: 1px dashed var(--accent);
            color: var(--accent);
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
        }

        .btn-add-key:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .key-pair-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: nowrap;
        }

        .key-select-group {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .key-select-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .key-pair-row select {
            width: 100%;
            min-width: 0;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .key-pair-row select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .key-pair-arrow {
            font-size: 1rem;
            color: var(--text-muted);
            flex-shrink: 0;
            padding-top: 18px;
        }

        .btn-remove-key {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            flex-shrink: 0;
            padding-top: 18px;
        }

        .btn-remove-key:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel {
            height: 40px;
            padding: 0 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: background-color var(--duration) var(--ease),
                        border-color var(--duration) var(--ease),
                        color var(--duration) var(--ease);
        }

        .btn-cancel:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .btn-confirm {
            height: 40px;
            padding: 0 24px;
            background: var(--gradient-success);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: opacity var(--duration) var(--ease),
                        transform var(--duration-fast) var(--ease);
        }

        .btn-confirm:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-confirm:active:not(:disabled) {
            transform: scale(0.98);
        }

        .btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            min-width: 0;
            background: var(--bg-primary);
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            height: 64px;
        }

        .header-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .active-table-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-hover);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            max-width: 400px;
        }

        .active-table-label {
            color: var(--text-muted);
            font-size: 0.8125rem;
            font-weight: 400;
        }

        .active-table-indicator span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .active-table-indicator:empty {
            display: none;
        }

        /* Upload Overlay */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .upload-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .upload-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .upload-overlay-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-overlay-sub {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-badge.loaded {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-badge.loaded .status-dot {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 32px 15%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        @media (max-width: 1400px) {
            .chat-messages {
                padding: 24px 10%;
            }
        }

        @media (max-width: 1024px) {
            .chat-messages {
                padding: 24px 5%;
            }
        }

        .chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
        }

        .chat-empty-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .chat-empty h3 {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .chat-empty p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .message {
            max-width: 85%;
            animation: fadeIn var(--duration-slow) var(--ease);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            line-height: 1.65;
            font-size: 0.9375rem;
        }

        .message.user .message-content {
            background: var(--accent);
            color: var(--accent-text);
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .message.assistant .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .table-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-muted);
            margin-bottom: 6px;
            border: 1px solid var(--border);
        }

        .table-badge.current {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Markdown */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 0.9rem;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .message-content th {
            background: var(--bg-hover);
            font-weight: 600;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border);
        }

        .message-content code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .message-content p {
            margin-bottom: 8px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Thinking & Tool Blocks */
        .thinking-block,
        .tool-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .thinking-block {
            border-left: 3px solid var(--accent);
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .thinking-content {
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .thinking-block.finished {
            border-left-color: var(--border);
            opacity: 0.8;
        }

        .thinking-block.finished .thinking-header {
            color: var(--text-secondary);
        }

        .tool-block {
            border-left: 3px solid var(--warning);
        }

        .tool-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .tool-name {
            background: rgba(245, 158, 11, 0.15);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .tool-args,
        .tool-result {
            background: var(--bg-primary);
            padding: 10px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            overflow-x: auto;
            margin-top: 8px;
        }

        .tool-result {
            max-height: 200px;
            overflow-y: auto;
        }

        .tool-result.has-chart {
            max-height: none;
            overflow: visible;
        }

        .tool-result.success {
            border-left: 2px solid var(--success);
        }

        .tool-result.error {
            border-left: 2px solid var(--error);
        }

        /* Â∑•ÂÖ∑ÊèèËø∞Ê†∑Âºè */
        .tool-description {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .tool-description b {
            color: var(--accent);
        }

        .tool-details {
            margin-top: 8px;
        }

        .tool-details summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 4px 0;
        }

        .tool-details summary:hover {
            color: var(--text-secondary);
        }

        /* Result display styles */
        .result-value {
            color: var(--success);
            font-weight: 600;
        }

        .result-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .result-data-preview {
            margin-top: 8px;
        }

        .result-data-preview summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .result-data-preview pre {
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 150px;
            font-size: 0.75rem;
        }

        .tool-result code {
            background: rgba(99, 102, 241, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        /* Chart Container Styles */
        .chart-result-container {
            margin-top: 12px;
        }

        .chart-header {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .chart-container {
            width: 100%;
            height: 400px;
            min-height: 400px;
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            padding: 16px;
            box-sizing: border-box;
        }

        /* Input Section */
        .chat-input-container {
            padding: 24px 15% 32px;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        @media (max-width: 1400px) {
            .chat-input-container {
                padding: 24px 10% 32px;
            }
        }

        @media (max-width: 1024px) {
            .chat-input-container {
                padding: 20px 5% 24px;
            }
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: border-color var(--duration) var(--ease),
                        box-shadow var(--duration) var(--ease);
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: var(--shadow-focus), var(--shadow-md);
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            resize: none;
            min-height: 48px;
            max-height: 180px;
            line-height: 1.5;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 14px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color var(--duration) var(--ease),
                        transform var(--duration-fast) var(--ease),
                        opacity var(--duration) var(--ease);
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 22px;
            height: 22px;
            fill: white;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Right Sidebar: Knowledge Base */
        .right-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
            padding: 20px 16px;
        }

        .knowledge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 0 4px 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .knowledge-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .knowledge-count {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.625rem;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: var(--radius-sm);
            min-width: 20px;
            text-align: center;
        }

        .knowledge-actions {
            display: flex;
            gap: 4px;
        }

        .kb-btn-small {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            padding: 4px 6px;
            border-radius: var(--radius-sm);
            transition: background-color var(--duration) var(--ease),
                        color var(--duration) var(--ease);
        }

        .kb-btn-small:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .knowledge-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow-y: auto;
            flex: 1;
            margin-top: 8px;
        }

        .knowledge-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color var(--duration) var(--ease),
                        border-color var(--duration) var(--ease);
            gap: 10px;
        }

        .knowledge-item:hover {
            background: var(--bg-subtle);
        }

        .knowledge-item.selected {
            background: rgba(16, 185, 129, 0.08);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .knowledge-icon {
            font-size: 0.9rem;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .knowledge-info {
            flex: 1;
            min-width: 0;
        }

        .knowledge-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .knowledge-meta {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .knowledge-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .knowledge-tag {
            font-size: 0.625rem;
            font-weight: 500;
            padding: 2px 7px;
            background: var(--accent-subtle);
            color: var(--accent);
            border-radius: var(--radius-sm);
        }

        .knowledge-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.125rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            border-radius: var(--radius-sm);
            transition: background-color var(--duration) var(--ease),
                        color var(--duration) var(--ease),
                        opacity var(--duration) var(--ease);
            flex-shrink: 0;
            opacity: 0;
        }

        .knowledge-item:hover .knowledge-delete {
            opacity: 1;
        }

        .knowledge-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .knowledge-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .knowledge-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-tertiary);
            margin-top: 8px;
        }

        .knowledge-upload-zone:hover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .knowledge-upload-zone.drag-over {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
        }

        .knowledge-upload-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .knowledge-upload-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Knowledge Modal */
        .kb-modal {
            width: 550px;
        }

        .kb-modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .kb-content-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }

        .kb-content-input {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            font-family: inherit;
        }

        .kb-content-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .kb-tags-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .kb-tags-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .kb-info-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .kb-info-item {
            flex: 1;
        }

        /* Password Modal */
        .password-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .password-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .password-modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .password-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .password-modal-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .password-input-group {
            margin-bottom: 20px;
        }

        .password-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .password-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .password-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .password-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .password-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .password-btn-cancel:hover {
            background: var(--border);
        }

        .password-btn-confirm {
            background: var(--gradient-1);
            color: white;
        }

        .password-btn-confirm:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <!-- Left Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>ExcelMind</h1>
            <div class="subtitle">Excel Intelligent Data Assistant</div>
        </div>

        <div class="upload-section">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">üìÅ</div>
                <p class="upload-text">Drag or click to upload Excel</p>
                <p class="upload-hint">Multiple files supported</p>
            </div>
            <input type="file" id="file-input" accept=".xlsx,.xls,.xlsm" multiple>
        </div>

        <div class="tables-section">
            <div class="tables-header">
                <div class="tables-title">
                    Data Tables
                    <span class="tables-count" id="tables-count">0</span>
                </div>
                <button class="btn-clear-all" id="btn-clear-all">Clear All</button>
            </div>
            <div class="tables-list" id="tables-list">
                <div class="tables-empty" id="tables-empty">No data tables available</div>
            </div>
            <div class="join-btn-container">
                <button class="btn-join" id="btn-join" disabled>
                    ü§ñ Smart Join
                </button>
            </div>
        </div>
    </aside>

    <!-- Join Modal -->
    <div class="modal-overlay" id="join-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>üîó Table Join</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Table Name</label>
                    <input type="text" class="form-input" id="join-name" placeholder="e.g., User_Orders_Joined">
                </div>

                <div class="table-preview" id="table1-preview"></div>
                <div class="table-preview" id="table2-preview"></div>

                <div class="form-group">
                    <label class="form-label">Join Keys <button type="button" class="btn-add-key" id="btn-add-key">+
                            Add Key</button></label>
                    <div id="key-pairs-container">
                        <!-- Key pairs will be added here dynamically -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Join Type</label>
                    <select class="form-select" id="join-type">
                        <option value="inner">inner - Keep matching rows only</option>
                        <option value="left">left - Keep all rows from left table</option>
                        <option value="right">right - Keep all rows from right table</option>
                        <option value="outer">outer - Keep all rows</option>
                    </select>
                </div>

                <div class="form-warning">
                    <span>‚ö†Ô∏è</span>
                    <span>Ensure join keys have consistent data types and meanings to avoid errors.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="join-cancel">Cancel</button>
                <button class="btn-confirm" id="join-confirm">Confirm Join</button>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div class="modal-overlay" id="kb-modal">
        <div class="modal kb-modal">
            <div class="modal-header">
                <h2 id="kb-modal-title">üìö Knowledge Details</h2>
                <button class="modal-close" id="kb-modal-close">&times;</button>
            </div>
            <div class="modal-body kb-modal-body">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="kb-title" placeholder="Knowledge entry title">
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="kb-content-input" id="kb-content" placeholder="Enter knowledge content..."></textarea>
                </div>
                <div class="kb-info-row">
                    <div class="kb-info-item">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="kb-category">
                            <option value="general">General</option>
                            <option value="field_rule">Field Rule</option>
                            <option value="task_pattern">Task Pattern</option>
                            <option value="business_logic">Business Logic</option>
                        </select>
                    </div>
                    <div class="kb-info-item">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="kb-priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="kb-tags-input" id="kb-tags" placeholder="e.g., billing_period, date_format, YYYYMM">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="kb-modal-cancel">Cancel</button>
                <button class="btn-confirm" id="kb-modal-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Upload Overlay -->
    <div class="upload-overlay" id="upload-overlay">
        <div class="upload-spinner"></div>
        <div class="upload-overlay-text" id="upload-overlay-text">Uploading...</div>
        <div class="upload-overlay-sub" id="upload-overlay-sub">Please wait, larger files may take some time</div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <header class="header">
            <span class="header-title">
                <span class="active-table-label">Current Target Table:</span>
                <div class="active-table-indicator" id="active-table-indicator">Please upload a data table first</div>
            </span>
        </header>

        <section class="chat-section">
            <div class="chat-messages" id="chat-messages">
                <div class="chat-empty" id="chat-empty">
                    <div class="chat-empty-icon">üí¨</div>
                    <h3>Start Conversation</h3>
                    <p>Upload an Excel file to start asking questions about your data</p>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chat-input" placeholder="Please upload an Excel file first" rows="1"
                        disabled></textarea>
                    <button class="send-btn" id="send-btn" disabled>
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" transform="rotate(-45 12 12)" />
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Right Sidebar: Knowledge Base -->
    <aside class="right-sidebar">
        <div class="knowledge-header">
            <div class="knowledge-title">
                üìö Knowledge Base
                <span class="knowledge-count" id="knowledge-count">0</span>
            </div>
            <div class="knowledge-actions">
                <button class="kb-btn-small" id="kb-btn-add" title="Add Knowledge">+</button>
                <button class="kb-btn-small" id="kb-btn-refresh" title="Refresh">‚Üª</button>
            </div>
        </div>
        <div class="knowledge-list" id="knowledge-list">
            <div class="knowledge-empty" id="knowledge-empty">No knowledge entries available</div>
        </div>
        <div class="knowledge-upload-zone" id="kb-upload-zone">
            <div class="knowledge-upload-icon">üìÑ</div>
            <p class="knowledge-upload-text">Drag or click to upload (.md/.txt)</p>
        </div>
        <input type="file" id="kb-file-input" accept=".md,.txt,.markdown" style="display:none">
    </aside>

    <!-- Password Modal -->
    <div class="password-modal-overlay" id="password-modal">
        <div class="password-modal">
            <div class="password-modal-title">üîê File Encrypted</div>
            <div class="password-modal-desc" id="password-filename">Please enter the password to decrypt the file</div>
            <div class="password-input-group">
                <label for="password-input">Password</label>
                <input type="password" id="password-input" class="password-input" placeholder="Enter password (leave empty if none)">
            </div>
            <div class="password-modal-actions">
                <button class="password-btn password-btn-cancel" id="password-cancel">Cancel</button>
                <button class="password-btn password-btn-confirm" id="password-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script>
        marked.setOptions({ breaks: true, gfm: true });

        // Elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const tablesList = document.getElementById('tables-list');
        const tablesCount = document.getElementById('tables-count');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const btnClearAll = document.getElementById('btn-clear-all');
        const btnJoin = document.getElementById('btn-join');
        const joinModal = document.getElementById('join-modal');
        const modalClose = document.getElementById('modal-close');
        const joinCancel = document.getElementById('join-cancel');
        const joinConfirm = document.getElementById('join-confirm');
        const joinName = document.getElementById('join-name');
        const keyPairsContainer = document.getElementById('key-pairs-container');
        const btnAddKey = document.getElementById('btn-add-key');
        const joinType = document.getElementById('join-type');
        const table1Preview = document.getElementById('table1-preview');
        const table2Preview = document.getElementById('table2-preview');
        const uploadOverlay = document.getElementById('upload-overlay');
        const uploadOverlayText = document.getElementById('upload-overlay-text');
        const uploadOverlaySub = document.getElementById('upload-overlay-sub');
        const activeTableIndicator = document.getElementById('active-table-indicator');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordFilename = document.getElementById('password-filename');
        const passwordCancel = document.getElementById('password-cancel');
        const passwordConfirm = document.getElementById('password-confirm');

        let isProcessing = false;
        let conversationHistory = [];
        let tables = [];
        let activeTableId = null;
        let tableNames = {};
        let selectedTableIds = [];
        let table1Columns = [];
        let table2Columns = [];
        let pendingFile = null; // Á≠âÂæÖÂØÜÁ†ÅËæìÂÖ•ÁöÑÊñá‰ª∂
        let passwordResolve = null; // Promise resolver

        // Password modal handlers
        passwordCancel.addEventListener('click', () => {
            passwordModal.classList.remove('show');
            passwordInput.value = '';
            if (passwordResolve) {
                passwordResolve(null);
                passwordResolve = null;
            }
            pendingFile = null;
        });

        passwordConfirm.addEventListener('click', () => {
            const password = passwordInput.value;
            passwordModal.classList.remove('show');
            passwordInput.value = '';
            if (passwordResolve) {
                passwordResolve(password);
                passwordResolve = null;
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordConfirm.click();
            }
        });

        // ÊòæÁ§∫ÂØÜÁ†ÅËæìÂÖ•Ê°Ü
        function showPasswordModal(filename) {
            return new Promise((resolve) => {
                passwordFilename.textContent = `File "${filename}" is encrypted, please enter password`;
                passwordInput.value = '';
                passwordModal.classList.add('show');
                passwordInput.focus();
                passwordResolve = resolve;
            });
        }

        // Upload handlers
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); });
        btnClearAll.addEventListener('click', async () => { if (confirm('Are you sure you want to clear all tables?')) await resetAgent(); });

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return ['.xlsx', '.xls', '.xlsm'].includes(ext);
            });

            if (validFiles.length === 0) return;

            // Show upload overlay
            uploadOverlay.classList.add('show');

            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                uploadOverlayText.textContent = `Uploading (${i + 1}/${validFiles.length}): ${file.name}`;
                uploadOverlaySub.textContent = 'Please wait, larger files may take some time';
                await uploadFile(file);
            }

            // Hide upload overlay
            uploadOverlay.classList.remove('show');
        }

        async function uploadFile(file, password = null) {
            const formData = new FormData();
            formData.append('file', file);
            if (password) {
                formData.append('password', password);
            }
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || 'Upload failed';

                    // Check for encryption error
                    if (errorMsg.includes('Âä†ÂØÜ') || errorMsg.includes('ÂØÜÁ†Å')) {
                        // Show password input
                        const enteredPassword = await showPasswordModal(file.name);
                        if (enteredPassword !== null) {
                            // User entered password, retry upload
                            return await uploadFile(file, enteredPassword);
                        } else {
                            // User cancelled
                            return;
                        }
                    }

                    throw new Error(errorMsg);
                }
                const data = await response.json();
                if (data.tables) updateTablesList(data.tables);
                if (data.table_id) {
                    activeTableId = data.table_id;
                    tableNames[data.table_id] = file.name;
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
            updateStatus();
        }

        function updateTablesList(tablesData) {
            tables = tablesData;
            tablesCount.textContent = tables.length;
            selectedTableIds = selectedTableIds.filter(id => tables.some(t => t.id === id));
            updateJoinButton();

            if (tables.length === 0) {
                tablesList.innerHTML = '<div class="tables-empty">No data tables available</div>';
                return;
            }

            tablesList.innerHTML = '';
            tables.forEach(table => {
                tableNames[table.id] = table.filename;
                const isSelected = selectedTableIds.includes(table.id);
                const icon = table.is_joined ? 'üîó' : 'üìä';
                const tooltip = table.is_joined && table.source_tables
                    ? `Joined table: ${table.source_tables.join(' + ')}`
                    : table.filename;

                const item = document.createElement('div');
                item.className = `table-item${table.is_active ? ' active' : ''}${isSelected ? ' selected' : ''}`;
                item.dataset.id = table.id;
                item.innerHTML = `
                    <input type="checkbox" class="table-checkbox" ${isSelected ? 'checked' : ''} ${table.is_joined ? 'disabled' : ''}>
                    <div class="table-item-left">
                        <span class="table-icon">${icon}</span>
                        <div class="table-info">
                            <div class="table-name" title="${tooltip}">${table.filename}</div>
                            <div class="table-meta">${table.total_rows} rows √ó ${table.total_columns} cols</div>
                        </div>
                    </div>
                    <button class="table-delete" title="Delete">√ó</button>
                `;

                const checkbox = item.querySelector('.table-checkbox');
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTableSelection(table.id, checkbox.checked);
                });

                item.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('table-delete') || e.target.classList.contains('table-checkbox')) return;
                    await setActiveTable(table.id);
                });

                item.querySelector('.table-delete').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await deleteTable(table.id);
                });

                tablesList.appendChild(item);
                if (table.is_active) activeTableId = table.id;
            });

            enableChat();
        }

        function toggleTableSelection(tableId, isChecked) {
            if (isChecked) {
                if (selectedTableIds.length < 2) {
                    selectedTableIds.push(tableId);
                } else {
                    // Âè™ÂÖÅËÆ∏ÈÄâ2‰∏™ÔºåÂèñÊ∂àÊúÄÊó©ÈÄâÁöÑ
                    selectedTableIds.shift();
                    selectedTableIds.push(tableId);
                    // Êõ¥Êñ∞UI
                    updateTablesList(tables);
                }
            } else {
                selectedTableIds = selectedTableIds.filter(id => id !== tableId);
            }
            updateJoinButton();
            updateTableItemStyles();
        }

        function updateTableItemStyles() {
            document.querySelectorAll('.table-item').forEach(item => {
                const id = item.dataset.id;
                const checkbox = item.querySelector('.table-checkbox');
                if (selectedTableIds.includes(id)) {
                    item.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    item.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            });
        }

        function updateJoinButton() {
            btnJoin.disabled = selectedTableIds.length !== 2;
            if (selectedTableIds.length === 2) {
                const t1 = tables.find(t => t.id === selectedTableIds[0]);
                const t2 = tables.find(t => t.id === selectedTableIds[1]);
                btnJoin.innerHTML = `ü§ñ Smart Join: ${t1?.filename?.substring(0, 6) || 'Table1'}... + ${t2?.filename?.substring(0, 6) || 'Table2'}...`;
            } else {
                btnJoin.innerHTML = selectedTableIds.length === 0
                    ? 'ü§ñ Smart Join (Select 2 tables)'
                    : `ü§ñ Smart Join (Selected ${selectedTableIds.length}/2)`;
            }
        }

        // Join Modal
        btnJoin.addEventListener('click', openJoinModal);
        modalClose.addEventListener('click', closeJoinModal);
        joinCancel.addEventListener('click', closeJoinModal);
        joinModal.addEventListener('click', (e) => { if (e.target === joinModal) closeJoinModal(); });
        btnAddKey.addEventListener('click', () => addKeyPair());

        function addKeyPair(key1Value = '', key2Value = '') {
            const row = document.createElement('div');
            row.className = 'key-pair-row';
            row.innerHTML = `
                <div class="key-select-group">
                    <span class="key-select-label">Table 1 Field</span>
                    <select class="key1-select">
                        ${table1Columns.map(c => `<option value="${c}" ${c === key1Value ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <span class="key-pair-arrow">‚Üî</span>
                <div class="key-select-group">
                    <span class="key-select-label">Table 2 Field</span>
                    <select class="key2-select">
                        ${table2Columns.map(c => `<option value="${c}" ${c === key2Value ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <button type="button" class="btn-remove-key" title="Remove">√ó</button>
            `;

            row.querySelector('.btn-remove-key').addEventListener('click', () => {
                if (keyPairsContainer.children.length > 1) {
                    row.remove();
                } else {
                    alert('At least one join key is required');
                }
            });

            keyPairsContainer.appendChild(row);
        }

        async function openJoinModal() {
            if (selectedTableIds.length !== 2) return;

            const [id1, id2] = selectedTableIds;
            const t1 = tables.find(t => t.id === id1);
            const t2 = tables.find(t => t.id === id2);

            // Show AI analysis overlay
            uploadOverlayText.textContent = 'ü§ñ AI is analyzing table structure...';
            uploadOverlaySub.textContent = 'Please wait, AI is matching join keys';
            uploadOverlay.classList.add('show');

            table1Preview.textContent = `Table 1: ${t1?.filename} (${t1?.total_rows} rows)`;
            table2Preview.textContent = `Table 2: ${t2?.filename} (${t2?.total_rows} rows)`;

            // Get column names
            try {
                const [cols1, cols2] = await Promise.all([
                    fetch(`/tables/${id1}/columns`).then(r => r.json()),
                    fetch(`/tables/${id2}/columns`).then(r => r.json())
                ]);

                table1Columns = cols1.columns || [];
                table2Columns = cols2.columns || [];
            } catch (e) {
                uploadOverlay.classList.remove('show');
                alert('Failed to get column information');
                return;
            }

            // Call AI suggestion API
            let aiSuggestion = null;
            try {
                const response = await fetch('/tables/suggest-join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table1_id: id1, table2_id: id2 })
                });

                if (response.ok) {
                    const data = await response.json();
                    aiSuggestion = data.suggestion;
                }
            } catch (e) {
                console.warn('Failed to get AI suggestion, using defaults', e);
            }

            uploadOverlay.classList.remove('show');

            // Clear and add key pairs
            keyPairsContainer.innerHTML = '';

            if (aiSuggestion && aiSuggestion.keys1 && aiSuggestion.keys2) {
                // Use AI suggestion to pre-fill
                joinName.value = aiSuggestion.new_name || `${t1?.filename?.split('.')[0]}_${t2?.filename?.split('.')[0]}_joined`;
                joinType.value = aiSuggestion.join_type || 'inner';

                // Add AI suggested key pairs
                for (let i = 0; i < aiSuggestion.keys1.length; i++) {
                    addKeyPair(aiSuggestion.keys1[i], aiSuggestion.keys2[i]);
                }

                // Show AI suggestion reason
                if (aiSuggestion.reason) {
                    console.log('AI suggestion reason:', aiSuggestion.reason);
                }
            } else {
                // Default values
                joinName.value = `${t1?.filename?.split('.')[0] || 'Table1'}_${t2?.filename?.split('.')[0] || 'Table2'}_joined`;
                addKeyPair();
            }

            joinModal.classList.add('show');
        }

        function closeJoinModal() {
            joinModal.classList.remove('show');
        }

        joinConfirm.addEventListener('click', async () => {
            const name = joinName.value.trim();
            if (!name) { alert('Please enter a new table name'); return; }

            // Collect all key pairs
            const keyRows = keyPairsContainer.querySelectorAll('.key-pair-row');
            const keys1 = [];
            const keys2 = [];

            keyRows.forEach(row => {
                keys1.push(row.querySelector('.key1-select').value);
                keys2.push(row.querySelector('.key2-select').value);
            });

            if (keys1.length === 0) {
                alert('At least one join key is required');
                return;
            }

            joinConfirm.disabled = true;
            joinConfirm.textContent = 'Joining...';

            try {
                const response = await fetch('/tables/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        table1_id: selectedTableIds[0],
                        table2_id: selectedTableIds[1],
                        keys1: keys1,
                        keys2: keys2,
                        join_type: joinType.value,
                        new_name: name
                    })
                });

                if (!response.ok) throw new Error((await response.json()).detail || 'Join failed');

                const data = await response.json();
                selectedTableIds = [];
                if (data.tables) updateTablesList(data.tables);
                closeJoinModal();
                updateStatus();
            } catch (error) {
                alert('Join failed: ' + error.message);
            } finally {
                joinConfirm.disabled = false;
                joinConfirm.textContent = 'Confirm Join';
            }
        });

        async function setActiveTable(tableId) {
            try {
                const response = await fetch('/tables/active', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_id: tableId })
                });
                if (!response.ok) throw new Error((await response.json()).detail);
                const data = await response.json();
                activeTableId = tableId;
                if (data.tables) updateTablesList(data.tables);
                updateStatus();
            } catch (error) {
                alert('Switch failed: ' + error.message);
            }
        }

        async function deleteTable(tableId) {
            try {
                const response = await fetch(`/tables/${tableId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error((await response.json()).detail);
                const data = await response.json();
                activeTableId = data.active_table_id;
                selectedTableIds = selectedTableIds.filter(id => id !== tableId);
                if (data.tables) updateTablesList(data.tables);
                updateStatus();
                if (tables.length === 0) disableChat();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        function updateStatus() {
            if (tables.length === 0) {
                activeTableIndicator.innerHTML = 'Please upload a data table first';
            } else {
                const activeTable = tables.find(t => t.is_active);
                // Update active table indicator
                if (activeTable) {
                    const icon = activeTable.is_joined ? 'üîó' : 'üìä';
                    activeTableIndicator.innerHTML = `${icon} <span title="${activeTable.filename}">${activeTable.filename}</span>`;
                } else {
                    activeTableIndicator.innerHTML = 'Please select a table';
                }
            }
        }

        function enableChat() {
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.placeholder = 'Type your question, e.g., How many rows are in this table?';
            chatInput.focus();
        }

        function disableChat() {
            chatInput.disabled = true;
            sendBtn.disabled = true;
            chatInput.placeholder = 'Please upload an Excel file first';
        }

        async function resetAgent() {
            try {
                await fetch('/reset', { method: 'POST' });
                tables = [];
                activeTableId = null;
                tableNames = {};
                conversationHistory = [];
                selectedTableIds = [];
                tablesList.innerHTML = '<div class="tables-empty">No data tables available</div>';
                tablesCount.textContent = '0';
                statusBadge.classList.remove('loaded');
                statusText.textContent = 'No file loaded';
                disableChat();
                updateJoinButton();
                chatMessages.innerHTML = `
                    <div class="chat-empty" id="chat-empty">
                        <div class="chat-empty-icon">üí¨</div>
                        <h3>Start Conversation</h3>
                        <p>Upload an Excel file to start asking questions about your data</p>
                    </div>
                `;
            } catch (error) { console.error('Reset failed:', error); }
        }

        // Chat handlers
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
        });
        sendBtn.addEventListener('click', sendMessage);

        const toolBlockMap = new Map();

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isProcessing || tables.length === 0) return;

            isProcessing = true;
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendBtn.disabled = true;
            toolBlockMap.clear();

            const emptyState = document.getElementById('chat-empty');
            if (emptyState) emptyState.remove();

            const currentTableId = activeTableId;
            const currentTableName = tableNames[currentTableId] || 'Êú™Áü•Ë°®';

            addMessage('user', message, currentTableId, currentTableName);
            conversationHistory.push({ role: 'user', content: message, tableId: currentTableId });

            const assistantMsg = addMessage('assistant', '', currentTableId, currentTableName);
            const contentDiv = assistantMsg.querySelector('.message-content');

            let currentThinkingBlock = null;
            let currentToolBlock = null;
            let responseContainer = document.createElement('div');
            contentDiv.appendChild(responseContainer);

            let responseTableId = currentTableId;

            try {
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        history: conversationHistory.slice(0, -1).map(h => ({
                            role: h.role,
                            content: h.content,
                            tableName: tableNames[h.tableId] || ''
                        }))
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let responseText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.slice(6));
                                if (event.type === 'table_info') { responseTableId = event.table_id; continue; }
                                handleStreamEvent(event, contentDiv, {
                                    getThinkingBlock: () => {
                                        if (!currentThinkingBlock) {
                                            currentThinkingBlock = createThinkingBlock();
                                            contentDiv.insertBefore(currentThinkingBlock, responseContainer);
                                        }
                                        return currentThinkingBlock;
                                    },
                                    finishThinkingBlock: () => {
                                        if (currentThinkingBlock) {
                                            currentThinkingBlock.classList.add('finished');

                                            // Hide loading animation
                                            const dots = currentThinkingBlock.querySelector('.loading-dots');
                                            if (dots) dots.remove(); // Remove completely

                                            // Update header text
                                            const headerText = currentThinkingBlock.querySelector('.thinking-header span:nth-child(2)');
                                            if (headerText) headerText.textContent = 'Thought Process';

                                            currentThinkingBlock = null;
                                        }
                                    },
                                    createToolBlock: (name, args) => {
                                        const block = createToolBlock(name, args);
                                        contentDiv.insertBefore(block, responseContainer);
                                        return block;
                                    },
                                    getCurrentToolBlock: () => currentToolBlock,
                                    setCurrentToolBlock: (block) => { currentToolBlock = block; },
                                    appendResponse: (text) => { responseText += text; responseContainer.innerHTML = formatMarkdown(responseText); },
                                    setResponse: (text) => { responseText = text; responseContainer.innerHTML = formatMarkdown(responseText); }
                                });
                            } catch (e) { console.error('Parse error:', e); }
                        }
                    }
                }

                if (responseText) {
                    conversationHistory.push({ role: 'assistant', content: responseText, tableId: responseTableId });
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                responseContainer.innerHTML = `<span style="color: var(--error)">ÈîôËØØ: ${error.message}</span>`;
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function handleStreamEvent(event, contentDiv, ctx) {
            switch (event.type) {
                case 'thinking':
                    const tb = ctx.getThinkingBlock();
                    tb.querySelector('.thinking-content').textContent = event.content;
                    tb.style.display = 'block';
                    break;
                case 'thinking_done': ctx.finishThinkingBlock(); break;
                case 'tool_call':
                    ctx.finishThinkingBlock();
                    const toolBlock = ctx.createToolBlock(event.name, event.args);
                    toolBlockMap.set(event.name, toolBlock);
                    ctx.setCurrentToolBlock(toolBlock);
                    break;
                case 'tool_result':
                    let targetBlock = toolBlockMap.get(event.name) || ctx.getCurrentToolBlock();
                    if (targetBlock) addToolResult(targetBlock, event.result);
                    break;
                case 'token': ctx.finishThinkingBlock(); ctx.appendResponse(event.content); break;
                case 'done': if (event.content) ctx.setResponse(event.content); break;
                case 'error': ctx.setResponse(`<span style="color: var(--error)">${event.content}</span>`); break;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(role, content, tableId, tableName) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.dataset.tableId = tableId || '';

            let tableBadge = '';
            if (tableId && tableName && role === 'assistant') {
                const isCurrentTable = tableId === activeTableId;
                tableBadge = `<div class="table-badge${isCurrentTable ? ' current' : ''}">üìä ${tableName}</div>`;
            }

            msgDiv.innerHTML = `<div class="message-content">${tableBadge}${formatMarkdown(content)}</div>`;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msgDiv;
        }

        function createThinkingBlock() {
            const div = document.createElement('div');
            div.className = 'thinking-block';
            div.innerHTML = `
                <div class="thinking-header">
                    <span>üß†</span><span>Thinking</span>
                    <div class="loading-dots"><span></span><span></span><span></span></div>
                </div>
                <div class="thinking-content"></div>
            `;
            return div;
        }

        function createToolBlock(name, args) {
            const div = document.createElement('div');
            div.className = 'tool-block';

            // Generate natural language description
            const description = getToolDescription(name, args);

            div.innerHTML = `
                <div class="tool-header"><span>üîß</span><span>Executing:</span><span class="tool-name">${getToolDisplayName(name)}</span></div>
                <div class="tool-description">${description}</div>
                <details class="tool-details">
                    <summary>View detailed parameters</summary>
                    <div class="tool-args">${JSON.stringify(args, null, 2)}</div>
                </details>
            `;
            return div;
        }

        // Get tool display name
        function getToolDisplayName(name) {
            const names = {
                'filter_data': 'Filter Data',
                'aggregate_data': 'Aggregate Data',
                'group_and_aggregate': 'Group Statistics',
                'sort_data': 'Sort Data',
                'search_data': 'Search Data',
                'get_column_stats': 'Column Statistics',
                'get_unique_values': 'Get Unique Values',
                'get_data_preview': 'Data Preview',
                'get_current_time': 'Get Time',
                'calculate': 'Math Calculation',
                'generate_chart': 'üìä Generate Chart'
            };
            return names[name] || name;
        }

        // Convert tool call parameters to natural language description
        function getToolDescription(name, args) {
            switch (name) {
                case 'filter_data': {
                    const parts = [];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    } else if (args.column && args.operator) {
                        parts.push(`Filter condition: ${formatCondition(args.column, args.operator, args.value)}`);
                    }
                    if (args.select_columns && args.select_columns.length > 0) {
                        parts.push(`Return columns: ${args.select_columns.join(', ')}`);
                    }
                    if (args.limit) parts.push(`Max ${args.limit} rows`);
                    return parts.join('<br>') || 'Filter data';
                }
                case 'aggregate_data': {
                    const parts = [];
                    const funcName = { sum: 'Sum', mean: 'Mean', count: 'Count', min: 'Min', max: 'Max', median: 'Median', std: 'Std Dev' };
                    parts.push(`Calculate <b>${funcName[args.agg_func] || args.agg_func}</b> of <b>${args.column}</b> column`);
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'group_and_aggregate': {
                    const funcName = { sum: 'Sum', mean: 'Mean', count: 'Count', min: 'Min', max: 'Max' };
                    const parts = [`Group by <b>${args.group_by}</b>, calculate <b>${funcName[args.agg_func] || args.agg_func}</b> of <b>${args.agg_column}</b>`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'sort_data': {
                    const order = args.ascending === false ? 'Descending' : 'Ascending';
                    const parts = [`Sort by <b>${args.column}</b> ${order}`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'search_data':
                    return `Search keyword: <b>${args.keyword}</b>` + (args.columns ? ` (in columns: ${args.columns.join(', ')})` : ' (all columns)');
                case 'get_column_stats': {
                    const parts = [`Get statistics for <b>${args.column}</b> column`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'get_unique_values': {
                    const parts = [`Get unique values from <b>${args.column}</b> column`];
                    if (args.filters && args.filters.length > 0) {
                        const conditions = args.filters.map(f => formatCondition(f.column, f.operator, f.value));
                        parts.push(`Filter conditions: ${conditions.join(' AND ')}`);
                    }
                    return parts.join('<br>');
                }
                case 'get_data_preview':
                    return `Preview first ${args.n_rows || 10} rows`;
                case 'get_current_time':
                    return 'Get current system time';
                case 'calculate':
                    if (args.expressions && args.expressions.length > 0) {
                        return `Calculate expressions: ${args.expressions.map(e => `<code>${e}</code>`).join(', ')}`;
                    }
                    return 'Perform mathematical calculation';
                case 'generate_chart': {
                    const chartTypes = { bar: 'Bar Chart', line: 'Line Chart', pie: 'Pie Chart', scatter: 'Scatter Plot', radar: 'Radar Chart', funnel: 'Funnel Chart', auto: 'Auto Recommend' };
                    const parts = [`Generate <b>${chartTypes[args.chart_type] || args.chart_type || 'Auto Recommend'}</b>`];
                    if (args.title) parts.push(`Title: ${args.title}`);
                    if (args.x_column) parts.push(`X-axis: ${args.x_column}`);
                    if (args.y_column) parts.push(`Y-axis: ${args.y_column}`);
                    if (args.group_by) parts.push(`Group by: ${args.group_by}`);
                    return parts.join(', ');
                }
                default:
                    return JSON.stringify(args);
            }
        }

        // Format filter conditions as natural language
        function formatCondition(column, operator, value) {
            const opNames = {
                '==': 'equals',
                '!=': 'not equals',
                '>': 'greater than',
                '<': 'less than',
                '>=': 'greater than or equal to',
                '<=': 'less than or equal to',
                'contains': 'contains',
                'startswith': 'starts with',
                'endswith': 'ends with'
            };
            return `<b>${column}</b> ${opNames[operator] || operator} <b>${value}</b>`;
        }

        function addToolResult(toolBlock, result) {
            const resultDiv = document.createElement('div');
            const isError = result && result.error;
            const hasChart = result && result.chart;
            resultDiv.className = `tool-result ${isError ? 'error' : 'success'}${hasChart ? ' has-chart' : ''}`;

            if (isError) {
                resultDiv.innerHTML = `<strong>‚ùå Error:</strong> ${result.error}`;
            } else {
                // Generate friendly result description
                resultDiv.innerHTML = formatToolResult(result);
            }
            toolBlock.appendChild(resultDiv);
        }

        // Convert tool results to friendly format
        function formatToolResult(result) {
            if (!result || typeof result !== 'object') {
                return `<strong>‚úì Result:</strong> ${result}`;
            }

            // Handle chart results
            if (result.chart) {
                const chartId = 'echart-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const chartHtml = `
                    <div class="chart-result-container">
                        <div class="chart-header"><strong>üìä ${result.message || 'Chart generated'}</strong></div>
                        <div class="chart-container" id="${chartId}"></div>
                    </div>
                `;
                // Delay chart rendering to ensure DOM is inserted
                setTimeout(() => {
                    const container = document.getElementById(chartId);
                    if (container && typeof echarts !== 'undefined') {
                        const chart = echarts.init(container, 'dark');
                        chart.setOption(result.chart);
                        // Responsive resize
                        const resizeObserver = new ResizeObserver(() => chart.resize());
                        resizeObserver.observe(container);
                    }
                }, 100);
                return chartHtml;
            }

            const parts = ['<strong>‚úì Success</strong>'];

            // Handle aggregation results
            if (result.result !== undefined && result.column && result.function) {
                const funcNames = { sum: 'Sum', mean: 'Mean', count: 'Count', min: 'Min', max: 'Max', median: 'Median', std: 'Std Dev' };
                parts.push(`${funcNames[result.function] || result.function} of <b>${result.column}</b>: <span class="result-value">${formatNumber(result.result)}</span>`);
                if (result.filtered_rows) {
                    parts.push(`<span class="result-meta">(based on ${result.filtered_rows} rows)</span>`);
                }
                return parts.join(' ');
            }

            // Handle time results
            if (result.current_time) {
                return `<strong>‚úì Current time:</strong> <span class="result-value">${result.current_time}</span> (${result.weekday || ''})`;
            }

            // Handle calculation results
            if (result.results && typeof result.results === 'object') {
                const calcParts = ['<strong>‚úì Calculation results:</strong><br>'];
                for (const [expr, val] of Object.entries(result.results)) {
                    calcParts.push(`<code>${expr}</code> = <span class="result-value">${formatNumber(val)}</span><br>`);
                }
                return calcParts.join('');
            }

            // Handle data list results
            if (result.data && Array.isArray(result.data)) {
                const summary = [`<strong>‚úì Found ${result.total_rows || result.data.length} rows</strong>`];
                if (result.returned_rows && result.returned_rows < result.total_rows) {
                    summary.push(`<span class="result-meta">(showing first ${result.returned_rows} rows)</span>`);
                }
                if (result.columns) {
                    summary.push(`<br><span class="result-meta">Columns: ${result.columns.join(', ')}</span>`);
                }
                // Show preview of first few rows
                if (result.data.length > 0) {
                    const preview = result.data.slice(0, 3);
                    summary.push('<details class="result-data-preview"><summary>View data preview</summary><pre>' + JSON.stringify(preview, null, 2) + '</pre></details>');
                }
                return summary.join(' ');
            }

            // Handle statistics
            if (result.column && (result.count !== undefined || result.unique_count !== undefined)) {
                const statParts = [`<strong>‚úì Statistics for ${result.column}:</strong><br>`];
                if (result.count !== undefined) statParts.push(`Count: <b>${result.count}</b> `);
                if (result.unique_count !== undefined) statParts.push(`Unique: <b>${result.unique_count}</b> `);
                if (result.null_count !== undefined) statParts.push(`Null: <b>${result.null_count}</b><br>`);
                if (result.min !== undefined) statParts.push(`Min: <b>${formatNumber(result.min)}</b> `);
                if (result.max !== undefined) statParts.push(`Max: <b>${formatNumber(result.max)}</b> `);
                if (result.mean !== undefined) statParts.push(`Mean: <b>${formatNumber(result.mean)}</b>`);
                return statParts.join('');
            }

            // Handle unique values results
            if (result.values && Array.isArray(result.values)) {
                const valueParts = [`<strong>‚úì ${result.column} has ${result.total_unique} unique values</strong>`];
                if (result.values.length > 0) {
                    const topValues = result.values.slice(0, 5).map(v => `${v.value} (${v.count})`).join(', ');
                    valueParts.push(`<br><span class="result-meta">Top values: ${topValues}${result.values.length > 5 ? '...' : ''}</span>`);
                }
                return valueParts.join('');
            }

            // Default: compact JSON display
            return `<strong>‚úì Result:</strong><details><summary>View details</summary><pre>${JSON.stringify(result, null, 2)}</pre></details>`;
        }

        // Ê†ºÂºèÂåñÊï∞Â≠ó
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            if (typeof num !== 'number') return num;
            if (Number.isInteger(num)) return num.toLocaleString();
            return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function formatMarkdown(text) {
            if (!text) return '';
            try { return marked.parse(text); }
            catch (e) { return text; }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                if (data.excel_loaded && data.tables) {
                    updateTablesList(data.tables);
                    updateStatus();
                }
            } catch (error) { console.error('Status check failed:', error); }
        }

        checkStatus();

        // ============ Knowledge Base Management ============

        const kbList = document.getElementById('knowledge-list');
        const kbCount = document.getElementById('knowledge-count');
        const kbEmpty = document.getElementById('knowledge-empty');
        const kbUploadZone = document.getElementById('kb-upload-zone');
        const kbFileInput = document.getElementById('kb-file-input');
        const kbBtnAdd = document.getElementById('kb-btn-add');
        const kbBtnRefresh = document.getElementById('kb-btn-refresh');
        const kbModal = document.getElementById('kb-modal');
        const kbModalTitle = document.getElementById('kb-modal-title');
        const kbModalClose = document.getElementById('kb-modal-close');
        const kbModalCancel = document.getElementById('kb-modal-cancel');
        const kbModalSave = document.getElementById('kb-modal-save');
        const kbTitleInput = document.getElementById('kb-title');
        const kbContentInput = document.getElementById('kb-content');
        const kbCategorySelect = document.getElementById('kb-category');
        const kbPrioritySelect = document.getElementById('kb-priority');
        const kbTagsInput = document.getElementById('kb-tags');

        let knowledgeEntries = [];
        let currentKbEditId = null;

        // Upload handlers for knowledge files
        kbUploadZone.addEventListener('click', () => kbFileInput.click());
        kbUploadZone.addEventListener('dragover', (e) => { e.preventDefault(); kbUploadZone.classList.add('drag-over'); });
        kbUploadZone.addEventListener('dragleave', () => kbUploadZone.classList.remove('drag-over'));
        kbUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            kbUploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleKbFiles(e.dataTransfer.files);
        });
        kbFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleKbFiles(e.target.files); });

        // Button handlers
        kbBtnAdd.addEventListener('click', () => openKbModal());
        kbBtnRefresh.addEventListener('click', () => loadKnowledgeEntries());
        kbModalClose.addEventListener('click', () => closeKbModal());
        kbModalCancel.addEventListener('click', () => closeKbModal());
        kbModalSave.addEventListener('click', () => saveKnowledgeEntry());

        async function handleKbFiles(files) {
            const validFiles = Array.from(files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return ['.md', '.txt', '.markdown'].includes(ext);
            });

            if (validFiles.length === 0) {
                alert('Only .md, .txt, .markdown files are supported');
                return;
            }

            for (const file of validFiles) {
                await uploadKbFile(file);
            }
            loadKnowledgeEntries();
        }

        async function uploadKbFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/knowledge/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error((await response.json()).detail || 'Upload failed');
                const data = await response.json();
                if (data.success) {
                    console.log('Knowledge file uploaded successfully:', data.title);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }

        async function loadKnowledgeEntries() {
            try {
                const response = await fetch('/knowledge');
                const data = await response.json();
                if (data.entries) {
                    knowledgeEntries = data.entries;
                    renderKnowledgeList();
                }
            } catch (error) {
                console.error('Failed to load knowledge base:', error);
            }
        }

        function renderKnowledgeList() {
            kbCount.textContent = knowledgeEntries.length;

            if (knowledgeEntries.length === 0) {
                kbList.innerHTML = '<div class="knowledge-empty">No knowledge entries available</div>';
                return;
            }

            kbList.innerHTML = knowledgeEntries.map(entry => {
                const categoryLabel = {
                    'general': 'General',
                    'field_rule': 'Field',
                    'task_pattern': 'Task',
                    'business_logic': 'Business'
                }[entry.category] || entry.category;

                const tagsHtml = (entry.tags || [])
                    .filter(t => t && t.trim())
                    .slice(0, 3)
                    .map(t => `<span class="knowledge-tag">${t}</span>`)
                    .join('');

                return `
                    <div class="knowledge-item" data-id="${entry.id}" onclick="viewKnowledgeEntry('${entry.id}')">
                        <span class="knowledge-icon">üìÑ</span>
                        <div class="knowledge-info">
                            <div class="knowledge-name">${entry.title || 'Untitled'}</div>
                            <div class="knowledge-meta">${categoryLabel}</div>
                            ${tagsHtml ? `<div class="knowledge-tags">${tagsHtml}</div>` : ''}
                        </div>
                        <button class="knowledge-delete" onclick="event.stopPropagation(); deleteKnowledgeEntry('${entry.id}')" title="Delete">√ó</button>
                    </div>
                `;
            }).join('');
        }

        async function viewKnowledgeEntry(id) {
            try {
                const response = await fetch(`/knowledge/${id}`);
                if (!response.ok) throw new Error('Failed to fetch');
                const entry = await response.json();

                currentKbEditId = id;
                kbModalTitle.textContent = 'üìù Edit Knowledge';
                kbTitleInput.value = entry.title || '';
                kbContentInput.value = entry.content || '';
                kbCategorySelect.value = entry.category || 'general';
                kbPrioritySelect.value = entry.priority || 'normal';
                kbTagsInput.value = (entry.tags || []).join(', ');

                kbModal.classList.add('show');
            } catch (error) {
                alert('Failed to get knowledge details: ' + error.message);
            }
        }

        function openKbModal() {
            currentKbEditId = null;
            kbModalTitle.textContent = 'üìö Add Knowledge';
            kbTitleInput.value = '';
            kbContentInput.value = '';
            kbCategorySelect.value = 'general';
            kbPrioritySelect.value = 'normal';
            kbTagsInput.value = '';
            kbModal.classList.add('show');
        }

        function closeKbModal() {
            kbModal.classList.remove('show');
            currentKbEditId = null;
        }

        async function saveKnowledgeEntry() {
            const content = kbContentInput.value.trim();
            if (!content) {
                alert('Please enter knowledge content');
                return;
            }

            const tags = kbTagsInput.value.split(',').map(t => t.trim()).filter(t => t);
            const data = {
                content: content,
                title: kbTitleInput.value.trim() || null,
                category: kbCategorySelect.value,
                priority: kbPrioritySelect.value,
                tags: tags
            };

            try {
                let response;
                if (currentKbEditId) {
                    // Update existing
                    response = await fetch(`/knowledge/${currentKbEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new
                    response = await fetch('/knowledge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) throw new Error((await response.json()).detail || 'Save failed');

                closeKbModal();
                loadKnowledgeEntries();
            } catch (error) {
                alert('Save failed: ' + error.message);
            }
        }

        async function deleteKnowledgeEntry(id) {
            if (!confirm('Are you sure you want to delete this knowledge entry?')) return;

            try {
                const response = await fetch(`/knowledge/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error((await response.json()).detail || 'Delete failed');
                loadKnowledgeEntries();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        // Make functions globally accessible
        window.viewKnowledgeEntry = viewKnowledgeEntry;
        window.deleteKnowledgeEntry = deleteKnowledgeEntry;

        // Load knowledge entries on page load
        loadKnowledgeEntries();
    </script>
</body>

</html>